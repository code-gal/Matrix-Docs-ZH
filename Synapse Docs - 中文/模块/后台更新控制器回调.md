### 后台更新控制器回调

后台更新控制器回调允许模块开发者控制（例如，限速）数据库后台更新的运行方式。数据库后台更新是 Synapse 在启动后在后台对其数据库执行的操作。  
它通常用于运行那些如果与模式更新（在启动时运行）同时进行会花费太长时间并过度延迟 Synapse 启动的数据库操作：用大量数据填充表格，在大表上添加索引，删除多余数据等。

可以使用模块 API 的 `register_background_update_controller_callbacks` 方法注册后台更新控制器回调。只有第一个模块（按照 Synapse 配置文件中的出现顺序）调用此方法可以注册后台更新控制器回调，后续调用将被忽略。

可用的后台更新控制器回调有：

##### `on_update`

_首次引入于 Synapse v1.49.0_

```
def on_update(update_name: str, database_name: str, one_shot: bool) -> AsyncContextManager[int]
```

在即将进行后台更新迭代时调用。模块将获得更新的名称、数据库的名称，以及一个标志，用于指示后台更新是否会一次性完成并可能需要很长时间（例如，创建索引）。  
如果最后一个参数设置为 `False` ，更新将分批运行。

该模块必须返回一个异步上下文管理器。在 Synapse 运行后台更新之前将进入该管理器；这应该返回迭代的期望持续时间，以毫秒为单位。

当迭代完成时，上下文管理器将退出。注意，上下文管理器返回的持续时间是一个目标，迭代可能需要更长或更短的时间。如果 `one_shot` 标志设置为 `True` ，则返回的持续时间将被忽略。

注意：与 Synapse 中的大多数模块回调不同，这个回调是同步的。这是因为异步操作预期由异步上下文管理器运行。

注册任何其他后台更新控制器回调时需要此回调。

##### `default_batch_size`

_首次引入于 Synapse v1.49.0_

```
async def default_batch_size(update_name: str, database_name: str) -> int
```

在后台更新的第一次迭代之前调用，带有更新的名称和数据库的名称。模块必须返回此第一次迭代中要处理的元素数量。

如果未定义此回调，Synapse 将使用默认值 100。

##### `min_batch_size`

_首次引入于 Synapse v1.49.0_

```
async def min_batch_size(update_name: str, database_name: str) -> int
```

在为后台更新运行新批次之前调用，带有更新的名称和数据库的名称。模块必须返回一个整数，表示此次迭代中要处理的最小元素数量。  
这个数字必须至少为 1，用于确保进度始终在推进。

如果未定义此回调，Synapse 将使用默认值 100。