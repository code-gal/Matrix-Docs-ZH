> **警告**
> 这些建筑笔记非常古老，追溯到Synapse只是孤立的联邦代码时代。这应该合并到主规范中。

### 服务器到服务器

#### 服务器到服务器堆栈

要使用服务器到服务器堆栈，主服务器只需与消息层交互即可。

服务器到服务器的设计分为四个不同的层：

1. 消息层
2. PDU层
3. 事务层
4. 传输层

其中底层（传输层）通过HTTP与互联网通信，而顶层（消息层）通过特定于域的API与主服务器的其余部分通信。

1. **消息层**

    这是主服务器的其余部分用来发送消息、加入房间等的地方。它还允许您注册回调，以便在收到来自下层（例如收到新消息）的通知时执行。

    它负责序列化发送到数据层的请求，并解析从数据层接收的请求。

2. **PDU层**

    此层处理：

		- 重复的`pdu_id` - 即确保我们忽略它们。
		- 响应对给定`pdu_id`的请求
		- 响应对给定上下文（即房间）的所有元数据的请求
		- 处理传入的回填请求

		所以它必须解析传入的消息以发现哪些是元数据，哪些不是，并且必须在适当的地方正确覆盖现有元数据。

    对于传入的PDU，它必须检查它引用的PDU以查看我们是否错过了任何。如果我们错过了，就去问另一个主服务器要。

3. **事务层**

		此层使传入请求变得幂等。也就是说，它存储我们已经看到的哪些事务ID以及我们的响应是什么。如果我们已经看到具有给定事务ID的消息，我们不会通知更高层，而是简单地用之前的响应进行响应。

		`transaction_id`来自"`GET /send//`"

		它还负责将PDU批量打包成单个事务以发送到远程目的地，这样我们就永远只有一个事务在给定目的地飞行。

		这也负责回答在给定一组事务之后的请求，即请求在'ver' X之后的所有内容。

4. **传输层**

		此层负责启动HTTP服务器并在事务层上调用正确的回调，以及发送数据和请求数据。

#### 持久化

我们在一个单一的sqlite3数据库中持久化数据。所有数据库查询都在一个单独的专用线程上运行。这意味着我们一次只能运行一个查询，使得以安全的方式做事情变得更加容易。

查询位于`synapse.persistence.transactions`模块中，表信息位于`synapse.persistence.tables`模块中。