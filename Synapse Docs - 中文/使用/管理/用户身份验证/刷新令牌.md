### 刷新令牌

Synapse 从 1.49 版本开始支持刷新令牌（一些早期版本支持 MSC2918 的早期实验性草案，但不兼容）。

#### 背景和动机

Synapse 用户的会话通过访问令牌来识别；访问令牌在用户登录时发放给用户。每个会话都会获得一个唯一的访问令牌来标识它；访问令牌必须保密，因为它授予对用户账户的访问权限。

传统上，这些访问令牌是永久有效的（至少直到用户明确选择注销为止）。

在某些情况下，为了减少泄露访问令牌可能造成的潜在损害，可能希望这些访问令牌有过期时间。另一方面，强制用户频繁重新认证（再次登录）可能过于不便。

刷新令牌是一种机制，可以在保持短访问令牌生命周期的大部分优势的同时，避免一些这种不便。刷新令牌也是 OAuth 2 中的一个概念——更多信息请参见此处。

当使用刷新令牌时，用户在登录时将同时获得一个访问令牌和一个刷新令牌。访问令牌将在预定时间后过期，但在其他方面与之前的工作方式相同。  
当访问令牌接近过期（或已过期）时，用户的客户端应向主服务器（Synapse）提供刷新令牌。

主服务器随后将为用户生成一个新的访问令牌和刷新令牌并返回它们。旧的刷新令牌将被作废且不能再次使用*。

最后，刷新令牌还可以使会话在自然结束之前，如果长时间不活动，就可以注销；请参阅下面的配置指南。

*为了防止客户端在刷新令牌过程中失去连接而出现问题，刷新令牌只有在新的访问令牌至少被使用一次后才会被使失效。就所有目的而言，以上简化已经足够。

#### 注意事项

有一些注意事项：

*   如果第三方同时获取了您的访问令牌和刷新令牌，他们将能够继续访问您的会话。
*   这仍然是一个改进，因为您（用户）会注意到您的会话过期，并且无法使用您的刷新令牌。这将表明其他人已经破坏了您的会话。您将能够再次登录并终止该会话。  
    以前（使用长寿命访问令牌），第三方拥有您的访问令牌可能很长时间都不会被发现。
*   客户端需要实现对刷新令牌的支持，以便它们成为一个有用的机制。
*   是否向不支持刷新令牌的客户端发放长效访问令牌，取决于主服务器管理员的决定。
    *   为了兼容性，他们很可能应该这样做，至少在客户端支持广泛之前。
        *   支持刷新令牌的客户端的用户仍然会从增加的安全性中受益；由于无法将会话降级为使用长效访问令牌，这实际上给了用户选择的权利。
    *   在一个封闭的环境中，所有用户都使用已知的客户端，这可能不是问题，因为主服务器管理员可以知道客户端是否支持刷新令牌。  
        在这种情况下，可以将不可刷新的访问令牌的生命周期设置为较短的持续时间，以提供类似的安全级别。

#### 配置指南

以下配置选项，在 `registration` 部分中，相关联：

*   `session_lifetime` : 会话的最大长度，即使它被刷新。换句话说，客户端必须在此时间段后再次登录。在大多数情况下，这可以不设置（无限）或设置为较长时间（年或月）。
*   `refreshable_access_token_lifetime` : 支持刷新令牌的客户端创建的访问令牌的生命周期。这应该很短；一个好的值可能是 5 分钟（ `5m` ）。
*   `nonrefreshable_access_token_lifetime` : 不支持刷新令牌的客户端创建的访问令牌的生命周期。如果您想有效地强制使用刷新令牌，请将其设置为短时间。  
如果您不想给不支持刷新令牌的客户端用户带来不便（通过强制他们频繁使用登录凭据重新认证），请将其设置为长时间。
*   `refresh_token_lifetime` : 刷新令牌的生命周期。换句话说，客户端必须在此时间段内刷新以维持其会话。除非您想注销不活动的会话，否则这里通常可以使用较长时间的值，甚至可以不设置（无限）。  
注意：将此设置得太短会给不经常连接的客户端带来不便，包括移动客户端和不常使用用户的客户端（因为这会使他们难以及时刷新，可能需要重新使用登录凭证进行身份验证）。

注意：以上四个选项仅在创建令牌时（通过登录或刷新）生效。对这些设置的更改不会溯及既往。

##### 使用刷新令牌过期来注销不活动的会话

如果您希望在不活动时强制会话登出，您可以启用可刷新的访问令牌过期和刷新令牌过期。

这是因为客户端必须在 `refresh_token_lifetime` 时间段内至少刷新一次以保持有效的凭证来访问账户。

(建议 `refresh_token_lifetime` 应长于 `refreshable_access_token_lifetime` ，本节为了简便起见假设情况如此。)

注意：这只会影响使用刷新令牌的会话。您可能希望设置一个较短的 `nonrefreshable_access_token_lifetime` 来防止不支持刷新令牌的客户端绕过此限制。

###### 选择保证允许某些不活动的值

可能需要允许一些短暂的不活动期，例如为了适应客户端连接的短暂中断。

以下模型旨在为选择 `refresh_token_lifetime` 和 `refreshable_access_token_lifetime` 提供指导，以满足如下要求：

1. 超过 `L` 的不活动时间必须导致会话被注销；并且
2. 不活动时间短于 `S` 不得导致会话注销。

此模型做出了最弱的假设，即所有活跃客户端将根据需要刷新以维持活跃的访问令牌，但不会更早。实际上，客户端可能比此模型假设的更频繁地刷新，但上述要求仍然有效。

为了满足上述模型，

*   `refresh_token_lifetime` 应设置为 `L` ; 并且
*   `refreshable_access_token_lifetime` 应设置为 `L - S` 。