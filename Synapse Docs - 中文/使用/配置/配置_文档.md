# 配置 Synapse
本文档旨在指导您进行 Synapse 配置。可以通过这里记录的众多配置设置来修改 Synapse 实例的行为——包括每个配置项的说明、默认值、如何更改默认值及该设置所影响的行为。此外，每个设置还包括示例配置。如果您不想花太多时间考虑选项，生成的配置会为所有值设置合理的默认值。但请注意，数据库默认是 SQLite，这不推荐用于生产环境。您可以在[这里](../../setup/installation.md#using-postgresql)阅读更多关于此主题的内容。

## 配置惯例
可以使用数字后接字母的形式设置需要 时间 时长的配置选项。字母含义如下：

* `s` = 秒
* `m` = 分钟
* `h` = 小时
* `d` = 天
* `w` = 星期
* `y` = 年
例如，设置 `redaction_retention_period: 5m` 会在五分钟后从数据库移除被删减的消息，而不是五个月。

另外，涉及大小的配置选项使用以下后缀：

* `K` = KiB，或 1024 字节
* `M` = MiB，或 1,048,576 字节
* `G` = GiB，或 1,073,741,824 字节
* `T` = TiB，或 1,099,511,627,776 字节
例如，设置 `max_avatar_size: 10M` 意味着 Synapse 不会接受大于 10,485,760 字节的用户头像文件。

## 配置验证
可以使用以下命令验证配置文件：

```bash
python -m synapse.config read <config key to print> -c <path to config>
```
要验证整个文件，请省略 `read <config key to print>`：

```bash
python -m synapse.config -c <path to config>
```
查看其他选项设置，请查阅帮助参考：

```bash
python -m synapse.config --help
```
### YAML
配置文件是一个 [YAML](https://yaml.org/) 文件，这意味着如果您希望配置文件被正确读取，必须遵循某些语法规则。几个需要了解的知识点：

* 配置中设置前的 `#` 将注释掉该设置，并应用默认值（如果可用），或者 Synapse 将忽略该设置。因此，在下面的示例 #1 中，配置将被读取并应用，而示例 #2 中将不会读取该设置，并将应用默认值。

   示例 #1：

   ```yaml
   pid_file: DATADIR/homeserver.pid
   ```
   示例 #2：

   ```yaml
   #pid_file: DATADIR/homeserver.pid
   ```
* 缩进很重要！设置前的缩进会决定某个设置是作为另一个设置的一部分读取，还是单独考虑。因此，在示例 #1 中，`enabled` 设置被读取为 `presence` 设置的子选项，并将正确应用。

  然而，示例 #2 中 `enabled` 设置前缺少缩进，意味着在读取配置时，Synapse 会将 `presence` 和 `enabled` 视为不同的设置。在这种情况下，`presence` 没有值，因此应用默认值，而 `enabled` 是一个 Synapse 不识别的选项，因此被忽略。

  示例 #1：

  ```yaml
  presence:
    enabled: false
  ```
  示例 #2：

  ```yaml
  presence:
  enabled: false
  ```
  
  在本手册中，所有顶级设置（无缩进）都在其部分开头标识（即“### `example_setting`”），如果有子选项，则在部分正文中标识和列出。此外，每个设置都提供了用法示例，并显示了正确的缩进。

## 模块
服务器管理员可以通过外部模块扩展 Synapse 的功能。

参见[这里](../../modules/index.md)以获取有关如何配置或创建 Synapse 自定义模块的更多文档。

---
### `modules`
使用 `module` 子选项在此选项下添加模块以扩展功能。然后，`module` 设置有一个子选项 `config`，用于定义 `module` 的一些配置。

默认值为无。

示例配置：

```yaml
modules:
  - module: my_super_module.MySuperClass
    config:
      do_thing: true
  - module: my_other_super_module.SomeClass
    config: {}
```
---
## 服务器
定义您的 homeserver 名称和其他基本选项。

---
### `server_name`
设置服务器的公共域名。

`server_name` 名称将出现在您服务器上创建的用户名和房间地址结尾。例如，如果 `server_name` 是 example.com，您服务器上的用户名将采用 `@user:example.com` 格式。

大多数情况下，您应该避免使用 matrix 特定子域名例如 matrix.example.com 或 synapse.example.com 作为 `server_name`，原因与不使用 user@email.example.com 作为邮箱地址相同。参见[这里](../../delegate.md)以获取有关如何在子域上托管 Synapse 的信息，同时保持干净的 `server_name`。

`server_name` 不能在以后更改，因此在启动 Synapse 之前正确配置这一点非常重要。它应该全部为小写，并可以包含显式端口。

此选项没有默认值。

示例配置 #1：

```yaml
server_name: matrix.org
```
示例配置 #2：

```yaml
server_name: localhost:8080
```
---
### `pid_file`
当 Synapse 作为守护进程运行时，用于存储 pid 的文件。默认值为无。

示例配置：

```yaml
pid_file: DATADIR/homeserver.pid
```
---
### `web_client_location`
重定向到的 web 客户端的绝对 URL。默认值为无。

示例配置：

```yaml
web_client_location: https://riot.example.com/
```
---
### `public_baseurl`
客户端访问此家庭服务器使用的公共基本 URL（不包括 _matrix/...）。这是用户可能在其客户端的“自定义家庭服务器 URL”字段中输入的 URL。如果您在反向代理中使用 Synapse，则应使用通过代理访问 Synapse 的 URL。否则，应使用访问 Synapse 的客户端 HTTP 监听器的 URL（见下文 ['listeners'](#listeners)）。

默认值为 `https://<server_name>/`。

示例配置：

```yaml
public_baseurl: https://example.com/
```
---
### `serve_server_wellknown`
默认情况下，其他服务器将尝试在端口 8448 上访问我们的服务器，这在某些环境中可能很不方便。

如果 `https://<server_name>/` 从端口 443 路由到 Synapse，则此选项配置 Synapse 在 `https://<server_name>/.well-known/matrix/server` 上提供一个文件。这将告知其他服务器将流量发送到端口 443。

此选项当前默认为 false。

有关更多信息，请查看[传入的联邦流量的委派](../../delegate.md)。

示例配置：

```yaml
serve_server_wellknown: true
```
---
### `extra_well_known_client_content`
此选项允许服务器运行者在[面向客户端的 `.well-known` 响应](https://spec.matrix.org/latest/client-server-api/#well-known-uri)中添加任意键值对。请注意，必须提供 `public_baseurl` 配置选项以便 Synapse 能够在 `/.well-known/matrix/client` 服务响应。

如果提供此选项，则会将给定的 yaml 解析为 json，并在 `/.well-known/matrix/client` 端点上与标准属性一起提供。

*添加于 Synapse 1.62.0。*
示例配置：

```yaml
extra_well_known_client_content :
  option1: value1
  option2: value2
```
---
### `soft_file_limit`
设置 Synapse 可以使用的文件描述符的软限制。零表示 Synapse 应将软限制设置为硬限制。默认值为 0。

示例配置：

```yaml
soft_file_limit: 3
```
---
### `presence`
存在感跟踪允许用户查看其他本地和远程用户的状态（例如在线/离线）。将 `enabled` 子选项设置为 false 可以禁用此家庭服务器上的存在感跟踪。默认值为 true。此选项取代了之前的顶级 'use_presence' 选项。

示例配置：

```yaml
presence:
  enabled: false
  include_offline_users_on_sync: false
```
`enabled` 也可以设置为特殊的 "untracked" 值，忽略通过客户端和联邦接收的更新，同时仍然接受来自[模块 API](../../modules/index.md)的更新。

*“untracked”选项添加于 Synapse 1.96.0。*
当客户端执行初始或 `full_state` 同步时，离线用户的存在感结果默认不包含。如果将 `include_offline_users_on_sync` 设置为 `true`，则始终在结果中包含离线用户。默认值为 false。

---
### `require_auth_for_profile_requests`
是否需要认证才能通过客户端 API 获取其他用户的个人资料数据（头像、显示名称）。默认值为 false。请注意，个人资料数据通过联邦 API 也可用，除非将 `allow_profile_lookup_over_federation` 设置为 false。

示例配置：

```yaml
require_auth_for_profile_requests: true
```
---
### `limit_profile_requests_to_users_who_share_rooms`
使用此选项要求用户和另一用户共享房间才能获取其个人资料信息。仅对客户端-服务器请求进行检查。来自其他服务器的个人资料请求应由请求服务器进行检查。默认值为 false。

示例配置：

```yaml
limit_profile_requests_to_users_who_share_rooms: true
```
---
### `include_profile_data_on_invite`
使用此选项以防止在用户加入之前其个人资料数据被获取并显示在房间中。默认情况下，无论上述两个设置的值如何，以及用户是否共享服务器，用户的个人资料数据都会被包含在邀请事件中。默认值为 true。

示例配置：

```yaml
include_profile_data_on_invite: false
```
---
### `allow_public_rooms_without_auth`
如果设置为 true，则无需认证即可通过客户端 API 访问服务器的公共房间目录，这意味着任何人都可以查询房间目录。默认值为 false。

示例配置：

```yaml
allow_public_rooms_without_auth: true
```
---
### `allow_public_rooms_over_federation`
如果设置为 true，则允许任何其他家庭服务器通过联邦获取服务器的公共房间目录。默认值为 false。

示例配置：

```yaml
allow_public_rooms_over_federation: true
```
---
### `default_room_version`
此服务器上新创建的房间的默认房间版本。

已知的房间版本列在[这里](https://spec.matrix.org/latest/rooms/#complete-list-of-room-versions)
例如，对于房间版本1，`default_room_version` 应设置为 "1"。

目前默认值为 ["10"](https://spec.matrix.org/v1.5/rooms/v10/)。

*更改于 Synapse 1.76:* 默认房间版本从[9](https://spec.matrix.org/v1.5/rooms/v9/) 增加到 [10](https://spec.matrix.org/v1.5/rooms/v10/)。

示例配置：

```yaml
default_room_version: "8"

```
---
### `gc_thresholds`
要传递给 `gc.set_threshold` 的垃圾回收阈值参数，如果定义的话。默认值为无。

示例配置：

```yaml
gc_thresholds: [700, 10, 10]
```
---
### `gc_min_interval`
设置各代之间每次垃圾回收的最短时间（秒计），无论垃圾回收阈值如何。这确保我们不会太频繁地进行垃圾回收。`[1s, 10s, 30s]` 的值指示两次连续的第0代垃圾回收之间必须有一秒钟的间隔，以此类推。

默认值为 `[1s, 10s, 30s]`。

示例配置：

```yaml
gc_min_interval: [0.5s, 30s, 1m]
```
---
### `filter_timeline_limit`
设置在获取和同步操作中时间线返回事件的限制。默认值为100。-1 表示没有上限。

示例配置：

```yaml
filter_timeline_limit: 5000
```
---
### `block_non_admin_invites`
是否阻止本服务器上用户（本地服务器管理员发送的除外）接收的房间邀请。默认值为 false。

示例配置：

```yaml
block_non_admin_invites: true
```
---
### `enable_search`
如果设置为 false，新消息将不会被索引以供搜索，用户在搜索消息时会收到错误。默认值为 true。

示例配置：

```yaml
enable_search: false
```
---
### `ip_range_blacklist`
此选项阻止将外发请求发送到指定的被黑名单的 IP 地址 CIDR 范围。如果未指定此选项，则默认是私有 IP 地址范围（参见下面的示例）。

黑名单适用于联邦请求、身份服务器、推送服务器以及用于检查第三方邀请事件键合法性的请求。

（无论是否在此显式列出，0.0.0.0 和 :: 总是被列入黑名单，因为它们对应不可以路由的地址。）
此选项取代了 Synapse v1.25.0 中的 `federation_ip_range_blacklist`。

注意：使用 HTTP 代理时，此值将被忽略。

示例配置：

```yaml
ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '192.0.0.0/24'
  - '169.254.0.0/16'
  - '192.88.99.0/24'
  - '198.18.0.0/15'
  - '192.0.2.0/24'
  - '198.51.100.0/24'
  - '203.0.113.0/24'
  - '224.0.0.0/4'
  - '::1/128'
  - 'fe80::/10'
  - 'fc00::/7'
  - '2001:db8::/32'
  - 'ff00::/8'
  - 'fec0::/10'
```
---
### `ip_range_whitelist`
允许用于联邦、身份服务器、推送服务器以及检查第三方邀请事件键合法性的 IP 地址 CIDR 范围列表。这对于指定广泛黑名单目标 IP 范围的例外情况非常有用，例如仅在您的网络中可见的推送服务器的通信。

此白名单会覆盖 `ip_range_blacklist`，默认值为空列表。

示例配置：

```yaml
ip_range_whitelist:
   - '192.168.1.1'
```
---
### `listeners`
Synapse 应该监听的端口列表、其用途及其配置。

每个监听器的子选项包括：

* `port`: 要绑定的 TCP 端口。
* `tag`: 日志名称中的端口别名。如设置，日志中记录的是标签而不是端口。默认值为 `None`，为可选项，仅对 `type: http` 的监听器有效。参见文档[请求日志格式](../administration/request_log.md)。
* `bind_addresses`: 要监听的本地地址列表。默认值是 “所有本地接口”。
* `type`: 监听器类型。通常为 `http`，但其他有效选项包括：
   * `manhole`: （查看文档[这里](../../manhole.md)），
   * `metrics`: （查看文档[这里](../../metrics-howto.md)），
* `tls`: 设置为 true 以启用此监听器的 TLS。将使用 tls_private_key_path / tls_certificate_path中指定的 TLS 密钥/证书。
* `x_forwarded`: 仅对“http”监听器有效。设置为 true 以使用 X-Forwarded-For 头作为客户端 IP。当 Synapse 位于[反向代理](../../reverse_proxy.md)之后时很有用。
* `request_id_header`: 从每个传入请求中提取的头部，用于产生请求 ID。请求 ID 用于[日志](../administration/request_log.md#request-log-format)和跟踪以关联和匹配请求。在未设置时，Synapse 将自动生成顺序请求 ID。当 Synapse 位于[反向代理](../../reverse_proxy.md)之后时，此选项很有用。
   *添加于 Synapse 1.68.0。*
* `resources`: 仅对“http”监听器有效。在此端口上托管的资源列表。每个资源的子选项是：
   * `names`: HTTP 资源名称的列表。有效资源名称列表参见下文。
   * `compress`: 设置为 true 以启用 HTTP 正文的 gzip 压缩。此项目前仅支持 `client`、`consent`、`metrics` 和 `federation` 资源。
* `additional_resources`: 仅对“http”监听器有效。通过动态模块加载的附加端点的地图。

Unix 套接字支持（*添加于 Synapse 1.89.0*）：

* `path`: Unix 套接字的路径和文件名。确保它位于具有读写权限的目录中，并且已经存在（不会创建目录）。默认值为 `None`。
  * **注意**：在相同的 `监听器` 上同时使用 `path` 和 `port` 选项不兼容。
  * 使用 Unix 套接字时，`x_forwarded` 选项默认为 true，可以省略。
  * 其他与 UNIX 套接字一起使用无意义的选项，如 `bind_addresses` 和 `tls`，将被忽略，可以移除。
* `mode`: 设置 UNIX 套接字的文件权限。默认值为 `666`
* **注意：** 必须设定为 `type: http` （不支持 `metrics` 和 `manhole`)。也要确保在 `resources` -> `names` 中不包括 `metrics`。

有效资源名称是：

* `client`: 客户端-服务器 API (/_matrix/client)。也意味着 `media` 和 `static`。如果配置为主进程，也意味着 Synapse 管理员 API (/_synapse/admin)。
* `consent`: 用户同意表单 (/_matrix/consent)。查看[这里](../../consent_tracking.md)了解更多。
* `federation`: 服务器-服务器 API (/_matrix/federation)。也意味着 `media`、`keys`、`openid`
* `keys`: 键发现 API (/_matrix/key)。
* `media`: 媒体 API (/_matrix/media)。
* `metrics`: 度量接口。查看[这里](../../metrics-howto.md)。（不兼容 Unix 套接字）
* `openid`: OpenID 认证。查看[这里](../../openid.md)。
* `replication`: HTTP 复制 API (/_synapse/replication)。查看[这里](../../workers.md)。
* `static`: 在 synapse/static 下的静态资源 (/_matrix/static)。（主要用于“回退身份验证”。）
* `health`: [健康检查端点 ](../../reverse_proxy.md#health-check-endpoint)。该端点在默认情况下对所有其他资源处于活动状态，且不必单独激活。只有当您想在已指定端口上或者为[工作者](../../workers.md)和无监听器的容器（例如[应用程序服务](../../workers.md#notifying-application-services)）上专门使用健康检查端点才有用。

示例配置 #1：

```yaml
listeners:
  # 启用 TLS 的监听器：用于当 matrix 流量直接发送到 synapse 时。

  #
  # （请注意，您还需给 Synapse 配置一个 TLS 密钥和证书：见以下 TLS 部分。）
  #
  - port: 8448
    type: http
    tls: true
    resources:
      - names: [client, federation]
```
示例配置 #2：

```yaml
listeners:
  # 不安全的 HTTP 监听器：用于当 matrix 流量经过一个解开 TLS 的反向代理时。

  #
  # 如果您计划使用反向代理，请参阅
  # https://element-hq.github.io/synapse/latest/reverse_proxy.html。

  #
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['::1', '127.0.0.1']
    resources:
      - names: [client, federation]
        compress: false
    # 附加资源示例：

    additional_resources:
      "/_matrix/my/custom/endpoint":
        module: my_module.CustomRequestHandler
        
# 启用本地给定端口的Twisted SSH Manhole服务。

# port.

  - port: 9000
    bind_addresses: ['::1', '127.0.0.1']
    type: manhole
```
示例配置#3：

```yaml
listeners:
# Unix socket监听器：适合于在反向代理后面的Synapse部署，提供轻量级的进程间通信，没有TCP/IP的开销，避免端口冲突，并通过系统文件权限提供增强的安全性。

# 注意，当使用UNIX socket时，x_forwarded默认会设为true。更多信息请参见https://element-hq.github.io/synapse/latest/reverse_proxy.html。

  - path: /run/synapse/main_public.sock
    type: http
    resources:
      - names: [client, federation]
```
---
### `manhole_settings`
Manhole的连接设定。可以在[这里](../../manhole.md)找到更多关于manhole的信息。Manhole子选项包括：

* `username`：manhole的用户名。默认是 'matrix'。
* `password`：manhole的密码。默认是 'rabbithole'。
* `ssh_priv_key_path` 和 `ssh_pub_key_path`：加密manhole流量所用的私人和公共SSH密钥对。

  如果未设置这些，则会使用硬编码且非机密的密钥，这可能会使流量在公共网络上传输时被拦截。

示例配置:
```yaml
manhole_settings:
  username: manhole
  password: mypassword
  ssh_priv_key_path: CONFDIR/id_rsa
  ssh_pub_key_path: CONFDIR/id_rsa.pub
```
### `dummy_events_threshold`
由于不同家庭服务器之间的网络延迟，转发极端事件可能会在一个房间中累积。一旦这种情况发生在一个大房间中，计算该房间的状态可能会变得相当昂贵。为了缓解这种情况，一旦转发极端事件的数量达到给定的阈值，Synapse会发送一个`org.matrix.dummy_event`事件，将减少该房间的转发极端事件。

此设置定义了发送虚拟事件的阈值（即房间内转发极端事件的数量）。默认值是10。

示例配置:
```yaml
dummy_events_threshold: 5
```
---
### `delete_stale_devices_after`
一个可选的时长。如果设置，Synapse将运行一个每日后台任务来注销并删除超过指定时间未被访问的设备。

默认为没有时长，这意味着设备永远不会被删除。

**注意：** 无论`run_background_tasks_on`的值如何，此任务将始终在主进程上运行。因为工作人员目前没有能力删除设备。

示例配置:
```yaml
delete_stale_devices_after: 1y
```
---
### `email`
Synapse的邮件发送配置。

服务器管理员可以配置电子邮件内容的自定义模板。更多信息请参见[这里](../../templates.md)。

此设置有以下子选项：

* `smtp_host`：要使用的外发SMTP服务器的主机名。默认是 'localhost'。
* `smtp_port`：邮件服务器上的外发SMTP端口。如果`force_tls`为true则默认为465，否则为25。

  _在Synapse 1.64.0中更改：_默认端口现在会考虑到`force_tls`。

* `smtp_user` 和 `smtp_pass`：用于SMTP服务器认证的用户名/密码。默认情况下，不会进行身份验证。
* `force_tls`：默认情况下，Synapse通过明文连接，然后可选地通过STARTTLS升级到TLS。如果此选项设置为true，则从一开始使用TLS（隐式TLS），并忽略选项`require_transport_security`。如果您的邮件服务器支持，建议启用此功能。

  _在Synapse 1.64.0中新增：_
* `require_transport_security`：设置为true以要求SMTP的TLS传输安全。默认情况下，Synapse会通过明文连接，然后在SMTP服务器支持的情况下切换到TLS via STARTTLS。如果此选项被设置，Synapse将拒绝连接，除非服务器支持STARTTLS。
* `enable_tls`：默认情况下，如果服务器支持TLS，则会使用，并且服务器必须提供一个验证'ded_sm'的有效证书。如果此选项设置为false，将不使用TLS。
* `notif_from`：定义发送邮件时使用的"From"地址。必须设置，如果有启用电子邮件发送。占位符'%(app)s'将被应用程序名称所取代，通常在'app_name'中设置，但可能被Matrix客户端应用程序覆盖。注意，占位符必须写作'%(app)s'，包括末尾的's'。
* `app_name`：`app_name`定义了'%(app)s'在`notif_from`和电子邮件主题中的默认值。默认为'Matrix'。
* `enable_notifs`：设置为true以允许用户接收电子邮件通知。如果未设置，用户可以配置电子邮件通知但不会接收到。默认禁用。
* `notif_for_new_users`：设置为false以禁用为新用户自动订阅电子邮件通知。默认启用。
* `notif_delay_before_mail`：发邮件通知前等待的时间。这给用户一个通过推送或开放客户端查看消息的机会。默认是10分钟。

  _在Synapse 1.99.0中新增：_
* `client_base_url`：邮件通知中的客户端链接的自定义URL。默认情况下，链接将基于"https://matrix.to" 。（此设置以前称为`riot_base_url`；旧名称仍然支持以确保向后兼容，但现已弃用。）
* `validation_token_lifetime`：配置验证邮件在发送后失效的时间。默认是1h。
* `invite_client_location`：在邀请过程中不在用户的位置重定向到web客户端位置。这被传递到身份服务器作为`org.matrix.web_client_location`键。默认为未设置，未给出身份服务器指导。
* `subjects`：用于发送来自Synapse的电子邮件通知时的主题。占位符'%(app)s'将被'app_name'设置的值替换，或者由Matrix客户端应用程序 dictcated。如果设置了主题，还可使用以下替换占位符：'%(person)s'，将被发送消息的人（或多人的）显示名称替换，例如"爱丽丝和鲍勃"，'%(room)s'，将被消息发送到的房间的名称替换，例如"我的超级房间"。此外，与帐户管理相关的电子邮件还可以使用'%(server_name)s'占位符，将被在Synapse配置中server_name的设置的值替换。

  这里是通知邮件可以设置的主题列表：

    * `message_from_person_in_room`：用于通知房间名称里的一个或多个用户发送的一条消息的主题。默认为"[%(app)s] %(进某个应用发来的信息在%(ání)s %()房间信息上的信息。"
    * `message_from_person`：用于通知无房名房间的一个或多个用户发来的消息的主题。默认为"[%(app)s] %(person)s在%(app)s上给您发了消息..."
    * `messages_from_person`：用于通知无房名房间的一个或多个用户所发多条消息的主题。默认为"[%(app)s] 您在%(app)s上有来自%(晓某)的信息...(啬"
    * `messages_in_room`：用于通知有房名房间的多个信息的主题。默认为"[%(app)s] 您在%(app)s上有来自%(room)s房间的信息..."
    * `messages_in_room_and_others`：用于通知多个房间里的多个信息。默认为"[%(app)s] 您在%(app)s上有来自%(room)s房间的信息， 和其他房间的信息..."
    * `messages_from_person_and_others`：用于通知多个房间里多个用户发来的消息。与上面的设置相似，只是在引发通知的房间没有名字时使用。默认为"[%(app)s] 您在%(app)s上的消息来自%(person)s和其他..."
    * `invite_from_person_to_room`：用于通知加入有房名房间邀请的主题。默认为"[%(app)s] %(person)s已邀请您加入%(room)s房间在%(app)s上..."
    * `invite_from_person`：用于通知加入无房名房间的邀请。默认为"[%(app)s] %(person)s已邀请您在%(app)s上聊天..."
    * `password_reset`：用于发送密码重设邮件の主题。默认是 "[%(server_name)s] 密码重置"
    * `email_validation`：用于发送验证邮件以确认地址所有权の主题。默认是 "[%(server_name)s] 验证您的邮件"

示例配置：

```yaml
email:
  smtp_host: mail.server
  smtp_port: 587
  smtp_user: "exampleusername"
  smtp_pass: "examplepassword"
  force_tls: true
  require_transport_security: true
  enable_tls: false
  notif_from: "Your Friendly %(app)s homeserver <noreply@example.com>"
  app_name: my_branded_matrix_server
  enable_notifs: true
  notif_for_new_users: false
  client_base_url: "http://localhost/riot"
  validation_token_lifetime: 15m
  invite_client_location: https://app.element.io

  subjects:
    message_from_person_in_room: "[%(app)s] You have a message on %(app)s from %(person)s in the %(room)s room..."
    message_from_person: "[%(app)s] You have a message on %(app)s from %(person)s..."
    messages_from_person: "[%(app)s] You have messages on %(app)s from %(person)s..."
    messages_in_room: "[%(app)s] You have messages on %(app)s in the %(room)s room..."
    messages_in_room_and_others: "[%(app)s] You have messages on %(app)s in the %(room)s room and others..."
    messages_from_person_and_others: "[%(app)s] You have messages on %(app)s from %(person)s and others..."
    invite_from_person_to_room: "[%(app)s] %(person)s has invited you to join the %(room)s room on %(app)s..."
    invite_from_person: "[%(app)s] %(person)s has invited you to chat on %(app)s..."
    password_reset: "[%(server_name)s] Password reset"
    email_validation: "[%(server_name)s] Validate your email"

```
---
### `max_event_delay_duration`
根据[MSC4140](https://github.com/matrix-org/matrix-spec-proposals/pull/4140)所规定的发送事件可能被推迟的最大允许时长。必须为正值如果设置。

默认为无时长（`null`），这不允许发送推迟事件。

示例配置:
```yaml
max_event_delay_duration: 24h
```
## 服务器封锁
对 Synapse 管理员有用的选项。

---
### `admin_contact`
如何联系服务器管理员，在 `ResourceLimitError` 中使用。默认为 none。

示例配置:
```yaml
admin_contact: 'mailto:admin@server.com'

```
---
### `hs_disabled` 和 `hs_disabled_message`
阻止用户连接到服务和给出一个人类可读的原因为什么连接被阻止。默认为 false。

示例配置:
```yaml
hs_disabled: true
hs_disabled_message: 'Reason for why the HS is blocked'

```
---
### `limit_usage_by_mau`
此选项可禁用/启用每月活动用户限制。用于在管理员或服务器拥有者希望限制的情况下，限制用户月活。启用时，如果达到限制，服务器返回一个错误类型为"Codes.RESOURCE_LIMIT_EXCEEDED"的"ResourceLimitError"。默认是false。如果启用，必须还设置一个值为`max_mau_value`。

参见[每月活动用户](../administration/monthly_active_users.md)的更多r如何配置 MAU 的详情。

示例配置:
```yaml
limit_usage_by_mau: true
```
---
### `max_mau_value`
此选项设置每月活跃用户的硬性上限，如果启用了 `limit_usage_by_mau`，服务器将在超过此上限时开始阻止用户操作。默认值为0。

示例配置：

```yaml
max_mau_value: 50
```
---
### `mau_trial_days`
选项 `mau_trial_days` 用于为活跃用户添加宽限期。这意味着用户必须在指定的天数内保持活跃，才能被视为活跃用户，并防止大量用户在短时间内注册后不再返回。默认值为0。

示例配置：

```yaml
mau_trial_days: 5
```
---
### `mau_appservice_trial_days`
选项 `mau_appservice_trial_days` 类似于 `mau_trial_days`，但如果用户是通过应用服务注册的，则应用不同的试用天数。值为0表示不应用试用天数。未在此字典中列出的应用服务使用 `mau_trial_days` 的值。

示例配置：

```yaml
mau_appservice_trial_days:
  my_appservice_id: 3
  another_appservice_id: 6
```
---
### `mau_limit_alerting`
选项 `mau_limit_alerting` 用于限制客户端警报，以防达到mau限制。这对于小型实例很有用，管理员可能为5个特定人员设置了5个mau席位，并且不希望进一步增加mau限制。默认值为true，表示启用警报。

示例配置：

```yaml
mau_limit_alerting: false
```
---
### `mau_stats_only`
如果启用，将填充每月活跃用户的指标，但不会基于这些数字限制任何人。如果 `limit_usage_by_mau` 为true，则隐含为true。默认值为false。

示例配置：

```yaml
mau_stats_only: true
```
---
### `mau_limit_reserved_threepids`
有时服务器管理员希望确保某些账户永远不会被mau检查阻止。这些账户通过此选项指定。默认值为无。通过指定保留的三方标识符（3rd party identifier）的 `medium` 和 `address` 来添加账户。

示例配置：

```yaml
mau_limit_reserved_threepids:
  - medium: 'email'

    address: 'reserved_user@example.com'

```
---
### `server_context`
此选项由phonehome统计用于将相关服务器分组。默认值为无。

示例配置：

```yaml
server_context: context
```
---
### `limit_remote_rooms`
启用此选项时，将在用户加入新的远程房间之前检查房间的“复杂性”。如果超过复杂性限制，服务器将不允许加入，或立即离开。这对于资源受限的家庭服务器很有用。此设置的选项包括：

* `enabled`：是否启用此检查。默认值为false。
* `complexity`：房间不能加入的复杂性限制。默认值为1.0。
* `complexity_error`：当房间过于复杂时，使用自定义消息覆盖返回的错误。
* `admins_can_join`：允许服务器管理员加入复杂房间。默认值为false。

房间复杂性是基于房间中用户数量等因素的任意度量。

示例配置：

```yaml
limit_remote_rooms:
  enabled: true
  complexity: 0.5
  complexity_error: "I can't let you do that, Dave."

  admins_can_join: true
```
---
### `require_membership_for_aliases`
是否要求用户在房间中才能为其添加别名。默认值为true。

示例配置：

```yaml
require_membership_for_aliases: false
```
---
### `allow_per_room_profiles`
是否允许通过发送包含与目标全局配置文件不同的配置信息的成员事件来允许每个房间的成员配置文件。默认值为true。

示例配置：

```yaml
allow_per_room_profiles: false
```
---
### `max_avatar_size`
用户头像的最大允许文件大小（以字节为单位）。默认情况下没有限制。使用M表示MB，K表示KB。

请注意，如果未使用Synapse的媒体库设置此项，则用户头像更改将不起作用。

示例配置：

```yaml
max_avatar_size: 10M
```
---
### `allowed_avatar_mimetypes`
允许的用户头像MIME类型。默认情况下没有限制。

请注意，如果未使用Synapse的媒体库设置此项，则用户头像更改将不起作用。

示例配置：

```yaml
allowed_avatar_mimetypes: ["image/png", "image/jpeg", "image/gif"]
```
---
### `redaction_retention_period`
在数据库中以未编辑形式保留已编辑事件的时间。此期限过后，已编辑事件将在数据库中替换为其编辑后的形式。

Synapse每5分钟检查一次已编辑事件的保留期是否结束。因此，即使此选项设置为 `0`，Synapse可能仍需要最多5分钟才能从数据库中清除已编辑事件。

默认值为 `7d`。设置为 `null` 以禁用。

示例配置：

```yaml
redaction_retention_period: 28d
```
---
### `forgotten_room_retention_period`
在从数据库中清除之前保留本地遗忘房间的时间。

默认值为 `null`，表示禁用。

示例配置：

```yaml
forgotten_room_retention_period: 28d
```
---
### `user_ips_max_age`
在数据库中跟踪用户最后一次访问时间和IP的时间。

默认值为 `28d`。设置为 `null` 以禁用清除旧行。

示例配置：

```yaml
user_ips_max_age: 14d
```
---
### `request_token_inhibit_3pid_errors`
禁止 `/requestToken` 端点返回可能泄露有关电子邮件地址是否在此家庭服务器上使用的信息的错误。默认值为false。

请注意，对于某些端点，错误情况是电子邮件已被使用，而对于其他端点，错误是输入的电子邮件未被使用。

如果启用此选项，这些端点将不会返回错误，而是像没有错误发生一样返回一个假的会话ID（'sid'）给客户端。

示例配置：

```yaml
request_token_inhibit_3pid_errors: true
```
---
### `next_link_domain_whitelist`
`next_link` 参数的域部分必须匹配的域列表。

客户端在请求验证电子邮件或电话号码时可以选择提供此参数，并映射到用户在验证成功后将自动重定向到的链接。客户端可以利用此参数来帮助验证过程。

无论家庭服务器还是身份服务器处理验证，白名单都适用。

默认值是不启用白名单功能；允许所有域。将此值设置为空列表将禁止所有域。

示例配置：

```yaml
next_link_domain_whitelist: ["matrix.org"]
```
---
### `templates` 和 `custom_template_directory`
这些选项定义生成电子邮件或HTML页面内容时使用的模板。`custom_template_directory` 确定Synapse将尝试在其中查找模板文件以用于生成电子邮件或HTML页面内容的目录。

如果未设置，或者在模板目录中未找到文件，将使用Synapse包中的默认模板。

有关使用自定义模板的更多信息，请参见[此处](../../templates.md)。

示例配置：

```yaml
templates:
  custom_template_directory: /path/to/custom/templates/
```
---
### `retention`
此选项和相关选项决定了服务器级别的消息保留策略。

房间管理员和版主可以使用 `m.room.retention` 状态事件为他们的房间定义保留期，服务器管理员可以通过设置 `allowed_lifetime_min` 和 `allowed_lifetime_max` 配置选项来限制此保留期。

如果启用了此功能，Synapse 将定期查找并清除超过房间最大保留期的事件。Synapse 还会过滤通过联邦接收到的事件，以便应已清除的事件被忽略而不再存储。

消息保留策略功能默认是禁用的。您可以在 [这里](../../message_retention_policies.md) 阅读更多关于此功能的信息。

此设置具有以下子选项：

* `default_policy`：默认保留策略。如果设置，Synapse 将其应用于缺少 `m.room.retention` 状态事件的房间。此选项通过与之关联的 `min_lifetime` 和 `max_lifetime` 子选项进一步指定。请注意，`min_lifetime` 的值不是很重要，因为 Synapse 尚未考虑到这一点。
* `allowed_lifetime_min` 和 `allowed_lifetime_max`：保留策略限制。如果设置，房间状态中包含 `m.room.retention` 事件，该事件包含超出这些界限的 `min_lifetime` 或 `max_lifetime`，Synapse 在执行清除任务时将把房间的策略限制在这些范围内。
* `purge_jobs` 和相关 `shortest_max_lifetime` 和 `longest_max_lifetime` 子选项：服务器管理员可以在 `purge_jobs` 部分定义后台清除过期事件的作业设置。

  如果未为此选项提供配置，将会设置一个作业来每天删除每个房间中的已过期事件。

  每个作业的配置定义了作业负责的消息生命周期范围。例如，如果 `shortest_max_lifetime` 是 '2d' 而 `longest_max_lifetime` 是 '3d'，则作业将负责清除房间状态中定义 `max_lifetime` 超过2天且小于或等于3天的事件。范围的最小值和最大值都是可选的，例如，一个作业没有 `shortest_max_lifetime` 而 `longest_max_lifetime` 为 '3d' 将处理所有保留策略中 `max_lifetime` 小于或等于三天的房间。

  xxxx每个作业配置的原因是某些房间可能有低 `max_lifetime` 的保留策略，在这种情况下，比其他房间更频繁地清除过时消息（例如每12小时）是有必要的，但又不希望通过遍历所有房间的作业来执行这种清理，因为这可能会给服务器带来沉重负担。

  如果配置了任何清除作业，强烈建议至少有一个作业没有设置 `shortest_max_lifetime` 或 `longest_max_lifetime`，或者一个作业没有 `shortest_max_lifetime` 和另一个没有设置 `longest_max_lifetime`。否则，即使设置了 `allowed_lifetime_min` 和 `allowed_lifetime_max`，某些房间可能被忽略，因为将房间策略限制在这些值是在从 Synapse 数据库中检索策略后（这是使用清除作业配置中指定的范围完成的）。

示例配置：

```yaml
retention:
  enabled: true
  default_policy:
    min_lifetime: 1d
    max_lifetime: 1y
  allowed_lifetime_min: 1d
  allowed_lifetime_max: 1y
  purge_jobs:
    - longest_max_lifetime: 3d
      interval: 12h
    - shortest_max_lifetime: 3d
      interval: 1d
```
---
## TLS
与 TLS 相关的选项。

---
### `tls_certificate_path`
此选项指定用于 TLS 的 PEM 编码的 X509 证书。从 Synapse 1.0 开始，证书需要是由认可证书颁发机构签署的、有效且可验证的证书。默认值为无。

确保使用包含完整证书链（包括任何中间证书）的 `.pem` 文件（例如，使用 certbot 时，使用 `fullchain.pem` 作为证书，而不是 `cert.pem`）。

示例配置：

```yaml
tls_certificate_path: "CONFDIR/SERVERNAME.tls.crt"

```
---
### `tls_private_key_path`
用于 TLS 的 PEM 编码私钥。默认值为无。

示例配置：

```yaml
tls_private_key_path: "CONFDIR/SERVERNAME.tls.key"

```
---
### `federation_verify_certificates`
是否验证外向联邦请求的 TLS 服务器证书。

默认值是 true。如需禁用证书验证，将选项设置为 false。

示例配置：

```yaml
federation_verify_certificates: false
```
---
### `federation_client_minimum_tls_version`
用于外向联邦请求的最低 TLS 版本。

默认设置为 `"1"`。可配置为 `"1"`、`"1.1"`、`"1.2"` 或 `"1.3"`。请注意，设置此值高于 `"1.2"` 将阻止与大多数公共 Matrix 网络进行联邦化：仅在完全私密的联邦设置下才配置为 `"1.3"`，并且可以确保 TLS 1.3 支持。

示例配置：

```yaml
federation_client_minimum_tls_version: "1.2"

```
---
### `federation_certificate_verification_whitelist`
跳过给定域白名单上的联邦证书验证。

此设置应仅在非常特殊的情况下使用，例如通过 Tor 隐藏服务进行联邦化等。对于家庭服务器的私有网络，您可能更希望使用私人 CA。

仅当 `federation_verify_certificates` 为 `true` 时有效。

示例配置：

```yaml
federation_certificate_verification_whitelist:
  - lon.example.com
  - "*.domain.com"

  - "*.onion"

```
---
### `federation_custom_ca_list`
用于联邦流量的自定义证书颁发机构列表。

此设置通常仅在家庭服务器的私有网络中使用。

请注意，此列表将替换操作环境提供的证书。证书必须为 PEM 格式。

示例配置：

```yaml
federation_custom_ca_list:
  - myCA1.pem
  - myCA2.pem
  - myCA3.pem
```
---
## Federation
与联邦相关的选项。

---
### `federation_domain_whitelist`
将联邦限制为给定的域白名单。 
请注意，我们建议在可能的情况下尽早限制您的联邦监听器以限制入站联邦流量，而不是仅依靠此应用层限制。 如果未指定，则默认是白名单一切。

请注意：这不会阻止服务器加入不在白名单上的服务器所在的房间。因此，此选项实际上仅适用于建立“私有联邦”，其中一组服务器都相互白名单并具有相同的白名单。

示例配置：

```yaml
federation_domain_whitelist:
  - lon.example.com
  - nyc.example.com
  - syd.example.com
```
---
### `federation_whitelist_endpoint_enabled`
启用用于获取联邦白名单配置的端点。

请求方法和路径为 `GET /_synapse/client/v1/config/federation_whitelist`，响应格式为：

```json
{
    "whitelist_enabled": true,  // 是否强制执行联邦白名单
    "whitelist": [  // 白名单允许哪些服务器名称
        "example.com"
    ]
}
```
如果 `whitelist_enabled` 为 `false`，则服务器允许与所有其他服务器联邦。

此端点需要身份验证。

示例配置：

```yaml
federation_whitelist_endpoint_enabled: true
```
---
### `federation_metrics_domains`
报告向给定域发送和从其接收 PDU 的 Prometheus 指标的年龄。这可用于大致了解入站和出站联邦上的“延迟”，但请注意，任何延迟都可能由于两端或中间网络的问题。

默认情况下，没有域会以这种方式进行监控。

示例配置：

```yaml
federation_metrics_domains:
  - matrix.org
  - example.com
```
---
### `allow_profile_lookup_over_federation`
设置为 false 禁止通过联邦进行资料查找。默认情况下，联邦 API 允许其他家庭服务器获取此家庭服务器上任何用户的资料数据。

示例配置：

```yaml
allow_profile_lookup_over_federation: false
```
---
### `allow_device_name_lookup_over_federation`
将此选项设置为 true 以允许通过联邦查找设备显示名称。默认情况下，联邦 API 阻止其他家庭服务器获取此家庭服务器上任何用户设备的显示名称。

示例配置：

```yaml
allow_device_name_lookup_over_federation: true
```
---
### `federation`
联邦部分定义了一些与联邦相关的子选项。

以下选项与配置一个请求的超时和重试逻辑有关，与其他请求无关。 
当某事或某人将等待请求得到答复时，使用短重试算法，而长重试则用于后台发生的请求，

比如发送联邦事务。

* `client_timeout`：联邦请求的超时。默认值为 60 秒。
* `max_short_retry_delay`：用于短重试算法的最大延迟。默认值为 2 秒。
* `max_long_retry_delay`：用于长重试算法的最大延迟。默认值为 60 秒。
* `max_short_retries`：短重试算法的最大重试次数。默认值为 3 次尝试。
* `max_long_retries`：长重试算法的最大重试次数。默认值为 10 次尝试。

以下选项控制与特定家庭服务器目标通信时的重试逻辑。与以前的配置选项不同，这些值适用于给定目标的所有请求，并且退避状态存储在数据库中。

* `destination_min_retry_interval`：首次请求失败后的初始退避。默认是 10 分钟。
* `destination_retry_multiplier`：每次失败后乘以退避的倍率。默认是 2。
* `destination_max_retry_interval`：退避的上限。默认是一周。

示例配置：

```yaml
federation:
  client_timeout: 180s
  max_short_retry_delay: 7s
  max_long_retry_delay: 100s
  max_short_retries: 5
  max_long_retries: 20
  destination_min_retry_interval: 30s
  destination_retry_multiplier: 5
  destination_max_retry_interval: 12h
```
---
## Caching
与缓存相关的选项。

---
### `event_cache_size`
要在内存中缓存的事件数。默认值是 10K。就像其他缓存一样，这受 `caches.global_factor`（见下文）影响。

例如，默认值是 10K，全球因子默认是 0.5。

由于 10K * 0.5 是 5K，因此事件缓存大小将是 5K。

受此配置影响的缓存名为“*getEvent*”。

请注意，此选项不是 `caches` 部分的一部分。

示例配置：

```yaml
event_cache_size: 15K
```
---
### `caches` 和相关值
缓存“因子”是可以应用于 Synapse 各个缓存以增加或减少可存储的最大条目数的乘数。

`caches` 可以通过以下子选项配置：

* `global_factor`：控制全局缓存因子，即如果没有为该缓存另行设置具体因子，则默认所有缓存的缓存因子。

  也可以通过 `SYNAPSE_CACHE_FACTOR` 环境变量设置。通过环境变量设置的优先级高于
通过配置文件设置。

  默认是 0.5，这将所有缓存的大小减半。

  请注意，改变此值也会影响 HTTP 连接池。

* `per_cache_factors`：指定缓存名与该个别缓存因子之间的字典。覆盖特定缓存的全局缓存因子。

   这些也可以通过由 `SYNAPSE_CACHE_FACTOR_` + 缓存名的大写字母和下划线组成的环境变量进行设置。通过环境变量设置的优先级高于通过配置文件设置。

   例如 `SYNAPSE_CACHE_FACTOR_GET_USERS_WHO_SHARE_ROOM_WITH_USER=2.0`
   
   一些缓存名称中包含 `*` 和其他非字母数字或下划线的字符。这些缓存可以在名称中保留或去除这些特殊字符。例如，通过环境变量指定 _stateGroupCache_ 的缓存因子，可以使用 `SYNAPSE_CACHE_FACTOR_STATEGROUPCACHE=2.0`。

* `expire_caches`：控制缓存条目在指定时间后是否被驱逐。默认是 true。设置为 false 禁用此功能。请注意，从不驱逐缓存可能导致过多的内存使用。
* `cache_entry_ttl`：如果 `expire_caches` 启用，此标志控制一个条目在没有被访问的情况下能在缓存中保留多久，然后被驱逐。默认是 30m。
* `sync_response_cache_duration`：控制/sync请求的结果在成功响应返回后缓存多长时间。较高的持续时间可以帮助具有间歇性连接的客户端，但代价是更多的内存使用。设置为零意味着不同步响应进行缓存。默认是 2m。
  *此项在 Synapse 1.62.0 中更改*：默认从0改为2m。

* `cache_autotuning` 及其子选项 `max_cache_memory_usage`、`target_cache_memory_usage` 和 `min_cache_ttl` 相互作用，维持在缓存内存使用和缓存条目可用性之间的平衡。您必须使用 [jemalloc](../administration/admin_faq.md#help-synapse-is-slow-and-eats-all-my-ramcpu) 才能利用此选项，并且必须指定以下列出的子选项的所有值以使此功能生效。请注意，如果未提供所有值，则该功能将无法工作并可能导致不稳定行为（例如过度清空缓存或异常）。请参阅 [配置常新增](#config-conventions) 以获取有关如何指定内存大小和缓存过期持续时间的信息。
     * `max_cache_memory_usage` 设置缓存可能使用的内存的上限，超出此内存前，条目会连续驱逐。直到内存使用降至以下设置所设定的 `target_cache_memory_usage` 或 `min_cache_ttl` 被达到。此选项没有默认值。
     * `target_cache_memory_usage` 设置缓存的目标内存使用量没有默认值。
     * `min_cache_ttl` 设置缓存条目不会被驱逐的限制，仅在超过 `max_cache_memory_usage` 时应用于缓存条目。此选项没有默认值。

示例配置：

```yaml
event_cache_size: 15K
caches:
  global_factor: 1.0
  per_cache_factors:
    get_users_who_share_room_with_user: 2.0
  sync_response_cache_duration: 2m
  cache_autotuning:
    max_cache_memory_usage: 1024M
    target_cache_memory_usage: 758M
    min_cache_ttl: 5m
```
### 重新加载缓存因子
缓存因子（即 `caches.global_factor` 和 `caches.per_cache_factors`）可以随时重新加载，通过向 Synapse 发送[`SIGHUP`](https://en.wikipedia.org/wiki/SIGHUP)信号实现，例如
```commandline
kill -HUP [PID_OF_SYNAPSE_PROCESS]
```
如果您运行多个工作进程，必须单独更新工作进程配置文件，并将此信号发送到每个工作进程。

如果您使用 [示例 systemd 服务](https://github.com/element-hq/synapse/blob/develop/contrib/systemd/matrix-synapse.service)文件，您可以通过使用 `systemctl reload matrix-synapse` 命令来发送 `SIGHUP` 信号。

---
## Database
与数据库设置相关的配置选项。

---
### `database`
`database` 设置定义了 Synapse 用于存储其所有数据的数据库。

相关子选项：

* `name`：此选项指定数据库引擎：`sqlite3`（用于 SQLite）或 `psycopg2`（用于 PostgreSQL）。如果未指定名称，Synapse 将默认为 SQLite。
* `txn_limit` 设置每个连接之前运行的最大事务数，然后重新连接。默认是 0，表示没有限制。
* `allow_unsafe_locale` 是 Postgres 特有的选项。在默认行为下，Synapse 将在 PostgreSQL 数据库设置为非 C 本地化时拒绝启动。您可以通过将 `allow_unsafe_locale` 设置为 true 来覆盖此行为（这*不建议*），请注意，这可能会损坏您的数据库。您可以在[这里](../../postgres.md#fixing-incorrect-collate-or-ctype)和[这里](https://wiki.postgresql.org/wiki/Locale_data_changes)找到更多信息。
* `args` 提供传递给数据库引擎的选项，但以 `cp_` 开头的选项除外，这些选项用于配置 Twisted 连接池。有关有效参数的参考，请参阅：
    * [sqlite](https://docs.python.org/3/library/sqlite3.html#sqlite3.connect)
    * [postgres](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-PARAMKEYWORDS)
    * [连接池](https://docs.twistedmatrix.com/en/stable/api/twisted.enterprise.adbapi.ConnectionPool.html#__init__)
有关使用 Synapse 与 Postgres 的更多信息，请参阅[这里](../../postgres.md)。

SQLite 示例配置：

```yaml
database:
  name: sqlite3
  args:
    database: /path/to/homeserver.db
```
Postgres 示例配置：

```yaml
database:
  name: psycopg2
  txn_limit: 10000
  args:
    user: synapse_user
    password: secretpassword
    dbname: synapse
    host: localhost
    port: 5432
    cp_min: 5
    cp_max: 10
```
---
### `databases`
`databases` 选项允许指定某些数据库表和数据库主机详细信息之间的映射，将单个 Synapse 实例的负载分散到多个数据库后端。这通常被称为“数据库分片”。此选项仅支持 PostgreSQL 数据库后端。

**重要提示：** 这是一个支持的选项，但目前不由 Matrix.org Foundation 在生产中使用。谨慎使用并始终备份。

`databases` 是一个任意命名的数据库条目字典。每个条目等价于 `database` 服务器配置选项的值（见上文），并增加了一个 `data_stores` 键。`data_stores` 是一个字符串数组，指定应该存储在关联数据库后端条目中的数据存储（为一组表定义的标签）。

`data_stores` 目前定义的值有：

* `"state"`：与状态组相关的数据库将存储在此数据库中。

  具体来说，这意味着以下表：

  * `state_groups`
  * `state_group_edges`
  * `state_groups_state`
  以及以下序列：

  * `state_groups_seq_id`
* `"main"`：所有其他数据库表和序列。

所有数据库将最终包含用于跟踪数据库模式迁移和任何未完成的后台更新的附加表。Synapse将在启动时自动创建这些表，以便检查和/或进行数据库模式迁移。

要将现有的数据库配置（例如，所有表在一个数据库中）迁移到其他配置（例如，在一个数据库上存储“main”数据，另一个数据库存储“state”），请执行以下操作：

1. 备份现有数据库。事情可能会出错，而数据库损坏不是小事！
2. 确保所有未完成的数据库迁移已被应用且后台更新已运行。最简单的方法是使用 Synapse 安装程序中提供的 `update_synapse_database` 脚本。

   ```sh
   update_synapse_database --database-config homeserver.yaml --run-background-updates
   ```
3. 从一个数据库复制必要的表和序列到另一个数据库。与数据库迁移、模式、模式版本和后台更新相关的表**不**应该被复制。

   例如，假设您想从现有的数据库中分离出“state”数据存储，而该数据库目前包含所有数据存储。

   只需从现有数据库中复制“state”数据存储上述定义的表和序列到第二个数据库。正如上面所述，Synapse 启动时将在第二个数据库中创建附加的表。

4. 修改/创建 `homeserver.yaml` 中的 `databases` 选项，以匹配所需的数据库配置。

5. 启动 Synapse。检查它是否成功启动并且功能通常正常。

6. 删除第三步中复制的旧表。

在配置中只可以指定 `database` 或 `databases` 中的一个选项，而不能同时指定。

示例配置：

```yaml
databases:
  basement_box:
    name: psycopg2
    txn_limit: 10000
    data_stores: ["main"]
    args:
      user: synapse_user
      password: secretpassword
      dbname: synapse_main
      host: localhost
      port: 5432
      cp_min: 5
      cp_max: 10
  my_other_database:
    name: psycopg2
    txn_limit: 10000
    data_stores: ["state"]
    args:
      user: synapse_user
      password: secretpassword
      dbname: synapse_state
      host: localhost
      port: 5432
      cp_min: 5
      cp_max: 10
```
---
## 日志记录
与日志记录相关的配置选项。

---
### `log_config`
此选项指定一个 YAML 格式的 Python 日志配置文件，详细描述见
[这里](https://docs.python.org/3/library/logging.config.html#configuration-dictionary-schema)。

示例配置：

```yaml
log_config: "CONFDIR/SERVERNAME.log.config"

```
---
## 速率限制
与 Synapse 中速率限制相关的选项。

每个速率限制配置由两个参数组成：
   - `per_second`: 客户端每秒可以发送的请求数量。
   - `burst_count`: 客户端在被限制前可以发送的请求数量。

---
### `rc_message`
客户端消息的速率限制设置。

这是基于客户端使用的帐户限制发送消息的选项。默认值为：`per_second: 0.2`, `burst_count: 10`。

示例配置：

```yaml
rc_message:
  per_second: 0.5
  burst_count: 15
```
---
### `rc_registration`
此选项基于客户端的 IP 地址限制注册请求。

默认值为 `per_second: 0.17`, `burst_count: 3`。

示例配置：

```yaml
rc_registration:
  per_second: 0.15
  burst_count: 2
```
---

### `rc_registration_token_validity`

此选项检查注册令牌的有效性，并根据客户端的IP地址限制请求速率。
默认值为 `per_second: 0.1`，`burst_count: 5`。

示例配置：
```yaml
rc_registration_token_validity:
  per_second: 0.3
  burst_count: 6
```
---
### `rc_login`

此选项指定登录的多个限制：
* `address` 基于客户端的IP地址限制登录请求速率。默认值为 `per_second: 0.003`，`burst_count: 5`。

* `account` 基于客户端尝试登录的账户限制登录请求速率。默认值为 `per_second: 0.003`，`burst_count: 5`。

* `failed_attempts` 基于账户的失败登录尝试次数限制登录请求速率。默认值为 `per_second: 0.17`，`burst_count: 3`。

示例配置：
```yaml
rc_login:
  address:
    per_second: 0.15
    burst_count: 5
  account:
    per_second: 0.18
    burst_count: 4
  failed_attempts:
    per_second: 0.19
    burst_count: 7
```
---
### `rc_admin_redaction`

此选项设置房间管理员的删除操作速率限制。如果未明确设置，则使用与 `rc_message` 相同的速率限制。这对于允许房间管理员快速处理滥用行为很有用。

示例配置：
```yaml
rc_admin_redaction:
  per_second: 1
  burst_count: 50
```
---
### `rc_joins`

此选项允许限制用户可以加入的房间数量。此设置具有以下子选项：

* `local`: 当用户加入服务器已在的房间时限制速率。默认值为 `per_second: 0.1`，`burst_count: 10`。

* `remote`: 当用户尝试加入不在服务器上的房间时限制速率（这可能比本地限制更耗费计算资源）。默认值为 `per_second: 0.01`，`burst_count: 10`。

示例配置：
```yaml
rc_joins:
  local:
    per_second: 0.2
    burst_count: 15
  remote:
    per_second: 0.03
    burst_count: 12
```
---
### `rc_joins_per_room`

此选项允许管理员根据最近加入该房间的次数（本地或远程）限制加入房间的速率。旨在减轻针对多个主服务器的大规模加入垃圾邮件攻击。

默认情况下，允许每秒加入一个房间，并有最多十次瞬时加入的累积缓冲。

示例配置（默认值）：
```yaml
rc_joins_per_room:
  per_second: 1
  burst_count: 10
```

_在 Synapse 1.64.0 中添加。_

---
### `rc_3pid_validation`

此选项限制用户或IP尝试验证3PID的频率。默认值为 `per_second: 0.003`，`burst_count: 5`。

示例配置：
```yaml
rc_3pid_validation:
  per_second: 0.003
  burst_count: 5
```
---
### `rc_invites`

此选项设置在房间中或向特定用户发送邀请的频率限制。`per_room` 默认值为 `per_second: 0.3`，`burst_count: 10`，`per_user` 默认值为 `per_second: 0.003`，`burst_count: 5`，`per_issuer` 默认值为 `per_second: 0.3`，`burst_count: 10`。

客户端请求在[创建房间](https://spec.matrix.org/v1.2/client-server-api/#post_matrixclientv3createroom)时邀请用户将计入 `rc_invites.per_room` 限制，而客户端请求[邀请单个用户到房间](https://spec.matrix.org/v1.2/client-server-api/#post_matrixclientv3roomsroomidinvite)将计入 `rc_invites.per_user` 和 `rc_invites.per_room` 限制。

联邦请求邀请用户将仅计入 `rc_invites.per_user` 限制，因为 Synapse 假定房间的速率限制将由发送服务器执行。

`rc_invites.per_user` 限制适用于邀请的*接收者*，而不是发送者，这意味着 `rc_invite.per_user.burst_count` 为5要求单个用户不能*接收*超过5次瞬时邀请。

相比之下，`rc_invites.per_issuer` 限制适用于邀请的*发起者*，这意味着 `rc_invite.per_issuer.burst_count` 为5要求单个用户不能*发送*超过5次瞬时邀请。

_在版本1.63中更改：_ 添加了 `per_issuer` 限制。

示例配置：
```yaml
rc_invites:
  per_room:
    per_second: 0.5
    burst_count: 5
  per_user:
    per_second: 0.004
    burst_count: 3
  per_issuer:
    per_second: 0.5
    burst_count: 5
```

---
### `rc_third_party_invite`

此选项基于发送邀请的账户限制3PID邀请（即发送到第三方ID如电子邮件地址或电话号码的邀请）的频率。默认值为 `per_second: 0.2`，`burst_count: 10`。

示例配置：
```yaml
rc_third_party_invite:
  per_second: 0.2
  burst_count: 10
```
---
### `rc_media_create`

此选项基于创建媒体的账户限制通过 `/_matrix/media/v1/create` 端点创建MXC URI的频率。默认值为 `per_second: 10`，`burst_count: 50`。

示例配置：
```yaml
rc_media_create:
  per_second: 10
  burst_count: 50
```
---
### `rc_federation`

定义对联邦请求的限制。

`rc_federation` 配置具有以下子选项：
* `window_size`: 窗口大小，以毫秒为单位。默认值为1000。
* `sleep_limit`: 在一个窗口中来自单个服务器的联邦请求数量，超过此数量后服务器将延迟处理请求。默认值为10。
* `sleep_delay`: 如果超过休眠限制，延迟处理来自远程服务器的事件的持续时间，以毫秒为单位。默认值为500。
* `reject_limit`: 允许来自单个服务器的最大并发联邦请求数量。默认值为50。
* `concurrent`: 从单个服务器并发处理的联邦请求数量。默认值为3。

示例配置：
```yaml
rc_federation:
  window_size: 750
  sleep_limit: 15
  sleep_delay: 400
  reject_limit: 40
  concurrent: 5
```
---
### `federation_rr_transactions_per_room_per_second`

设置发送已读回执的外发联邦事务频率，每个房间。

如果我们最终尝试发送更多的已读回执，它们将被缓冲到更少的事务中。默认值为50。

示例配置：
```yaml
federation_rr_transactions_per_room_per_second: 40
```
---
## 媒体存储
与Synapse媒体存储相关的配置选项。

---
### `enable_authenticated_media`

设置为true时，所有后续的媒体上传将标记为已认证，并且不会通过传统的未认证媒体端点（`/_matrix/media/(r0|v3|v1)/download` 和 `/_matrix/media/(r0|v3|v1)/thumbnail`）提供 - 对这些端点的已认证媒体请求将导致404。所有媒体，包括已认证媒体，将通过已认证媒体端点 `_matrix/client/v1/media/download` 和 `_matrix/client/v1/media/thumbnail` 提供。在将此选项设置为true之前上传的媒体仍将通过传统端点提供。请注意，如果在启用后将设置切换为false，标记为已认证的媒体将通过传统端点提供。默认值为false，但在未来的Synapse版本中将更改为true。

示例配置：
```yaml
enable_authenticated_media: true
```
---
### `enable_media_repo`

在Synapse主服务器中启用媒体存储服务。默认值为true。
如果您使用单独的媒体存储工作程序，请设置为false。

示例配置：
```yaml
enable_media_repo: false
```
---
### `media_store_path`

存储上传的图像和附件的目录。

示例配置：
```yaml
media_store_path: "DATADIR/media_store"
```
---
### `max_pending_media_uploads`

给定用户可以拥有多少*待处理的媒体上传*？待处理的媒体上传是一个创建的MXC URI，(a) 未过期（`unused_expires_at` 时间戳未过期）且 (b) 媒体尚未上传。默认值为5。

示例配置：
```yaml
max_pending_media_uploads: 5
```
---
### `unused_expiration_time`

在过期创建的媒体ID之前等待的时间，以毫秒为单位。默认值为"24h"。

示例配置：
```yaml
unused_expiration_time: "1h"
```
---
### `media_storage_providers`

媒体存储提供者允许将媒体存储在不同的位置。默认值为无。相关的子选项有：
* `module`: 资源类型，例如 `file_system`。
* `store_local`: 是否存储新上传的本地文件
* `store_remote`: 是否存储新下载的本地文件
* `store_synchronous`: 是否等待本地上传的成功存储
* `config`: 通过 `directory` 选项设置资源路径

示例配置：
```yaml
media_storage_providers:
  - module: file_system
    store_local: false
    store_remote: false
    store_synchronous: false
    config:
       directory: /mnt/some/other/directory
```
---
### `max_upload_size`

允许的最大上传大小，以字节为单位。

如果您使用反向代理，您可能还需要在反向代理的配置中设置此值。默认值为50M。特别是Nginx默认的最大主体大小较小。有关使用反向代理与Synapse的更多信息，请参见[此处](../../reverse_proxy.md)。

示例配置：
```yaml
max_upload_size: 60M
```
---
### `max_image_pixels`

将缩略图的最大像素数。默认值为32M。

示例配置：
```yaml
max_image_pixels: 35M
```
---
### `remote_media_download_burst_count`

远程媒体下载使用[漏桶算法](https://en.wikipedia.org/wiki/Leaky_bucket)进行速率限制，其中给定的“桶”是根据请求远程媒体下载的请求者的IP地址进行键控的。此配置选项设置用于惩罚下载字节大小的桶的大小 - 如果桶已满，即已下载给定数量的字节，则进一步的下载将被拒绝，直到桶排空。默认值为500MiB。另请参见 `remote_media_download_per_second`，该选项确定“桶”排空的速率，从而有可用空间授权新请求。

示例配置：
```yaml
remote_media_download_burst_count: 200M
```
---
### `remote_media_download_per_second`

与 `remote_media_download_burst_count` 一起工作以限制远程媒体下载 - 此配置选项确定“桶”（见上文）以每秒字节数排空的速率。当请求下载远程媒体时，这些请求的字节大小将添加到桶中，一旦桶达到其容量，将不再允许请求，直到桶中“排出”一定数量的字节。此设置确定字节从桶中排出的速率，实际效果是数字越大，桶排空越快，允许在较短时间内下载更多字节。默认值为每秒87KiB。另请参见 `remote_media_download_burst_count`。

示例配置：
```yaml
remote_media_download_per_second: 40K
```
---
### `prevent_media_downloads_from`

不允许从哪些域下载媒体的列表。这些域中已下载的媒体将不会被删除，但用户将无法访问。此选项不会影响尝试下载/操作媒体的管理员API。

这不会阻止列出的域访问媒体本身。它只是阻止此服务器上的用户下载源自列出服务器的媒体。

这对源自本地服务器的媒体没有影响。这仅影响从其他Matrix服务器下载的媒体，要控制URL预览，请参见[`url_preview_ip_range_blacklist`](#url_preview_ip_range_blacklist)或[`url_preview_url_blacklist`](#url_preview_url_blacklist)。

默认值为空列表（无阻止）。

示例配置：
```yaml
prevent_media_downloads_from:
  - evil.example.org
  - evil2.example.org
```
---
### `dynamic_thumbnails`

是否动态生成新的缩略图以精确匹配客户端请求的分辨率。如果为true，则每当客户端请求新的分辨率时，服务器将生成新的缩略图。如果为false，服务器将从预先计算的列表中选择一个缩略图。默认值为false。

示例配置：
```yaml
dynamic_thumbnails: true
```
---
### `thumbnail_sizes`

上传图像时要预先计算的缩略图列表。相关的子选项有：
* `width`
* `height`
* `method`: 即 `crop`，`scale` 等。

示例配置：
```yaml
thumbnail_sizes:
  - width: 32
    height: 32
    method: crop
  - width: 96
    height: 96
    method: crop
  - width: 320
    height: 240
    method: scale
  - width: 640
    height: 480
    method: scale
  - width: 800
    height: 600
    method: scale
```
---
### `media_retention`

控制是否应在某些条件下删除本地媒体和远程媒体缓存（从其他主服务器下载的媒体）中的条目，通常是为了节省空间。

媒体文件的清除将由媒体工作程序执行（即，`enable_media_repo` 主服务器配置选项设置为'true'的工作程序）。这可能是主进程。

`media_retention.local_media_lifetime` 和 `media_retention.remote_media_lifetime` 配置选项控制如果在给定时间内未访问媒体，是否将其清除。请注意，当媒体在客户端的房间中加载或由本地或远程用户下载时，媒体被“访问”。如果媒体从未被访问，则使用媒体的创建时间。缩略图和原始媒体都将被删除。如果这些选项中的任何一个未设置，则不会清除该类型的媒体。

已[隔离](../../admin_api/media_admin_api.md#quarantining-media-in-a-room)的本地或缓存的远程媒体不会被删除。同样，已标记为[保护不被隔离](../../admin_api/media_admin_api.md#protecting-media-from-being-quarantined)的本地媒体也不会被删除。

示例配置：
```yaml
media_retention:
    local_media_lifetime: 90d
    remote_media_lifetime: 14d
```
---
### `url_preview_enabled`

此设置确定是否启用预览URL API。
默认情况下禁用。设置为true以启用。如果启用，您必须指定一个`url_preview_ip_range_blacklist`黑名单。

示例配置：
```yaml
url_preview_enabled: true
```
---
### `url_preview_ip_range_blacklist`

URL预览蜘蛛被禁止访问的IP地址CIDR范围列表。默认情况下没有设置：您必须明确指定一个列表才能使URL预览功能正常工作。您应该指定网络中不希望synapse尝试连接的任何内部服务，否则任何Matrix房间中的人都可能导致您的synapse向内部服务发出任意GET请求，从而引发严重的安全问题。

(0.0.0.0和::总是被列入黑名单，无论它们是否在此明确列出，因为它们对应于不可路由的地址。)

如果设置了`url_preview_enabled`，则必须指定此项。建议您使用以下示例列表作为起点。

注意：当使用HTTP代理时，该值将被忽略。

示例配置：
```yaml
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '192.0.0.0/24'
  - '169.254.0.0/16'
  - '192.88.99.0/24'
  - '198.18.0.0/15'
  - '192.0.2.0/24'
  - '198.51.100.0/24'
  - '203.0.113.0/24'
  - '224.0.0.0/4'
  - '::1/128'
  - 'fe80::/10'
  - 'fc00::/7'
  - '2001:db8::/32'
  - 'ff00::/8'
  - 'fec0::/10'
```
---

### `url_preview_ip_range_whitelist`
此选项设置一组允许URL预览爬虫访问的IP地址CIDR范围，即使它们在`url_preview_ip_range_blacklist`中被列出。这对于指定广泛的黑名单目标IP范围的例外情况很有用，例如仅在您的网络中可见的特定私有网站启用URL预览。默认没有。

示例配置:
```yaml
url_preview_ip_range_whitelist:
   - '192.168.1.1'

```
---
### `url_preview_url_blacklist`
阻止URL预览爬虫访问的URL匹配列表。此功能目的是提高可用性，而非安全性。因此，应优先使用`url_preview_ip_range_blacklist`，否则可能有人定义指向私有IP地址的公共DNS条目，从而绕过黑名单。某些重定向请求或检查到Synapse访问后提供不同内容的应用也可能绕过黑名单。此功能更适用于显然不希望Synapse预览的URL形状。

每个列表条目都是一个URL组件属性字典，如`urlparse.urlsplit`应用于绝对URL形式之后所返回的信息。详见[这里](https://docs.python.org/2/library/urlparse.html#urlparse.urlsplit)。一些例子包括:
* `username`
* `netloc`
* `scheme`
* `path`
字典的值被视作应用于URL组件的文件名匹配模式，除非以^开头，此时被视为正则表达式匹配。若为某列表项指定的所有组件匹配成功，则URL被列入黑名单。

示例配置:
```yaml
url_preview_url_blacklist:
  # 黑名单中含有用户名的任何URL
  - username: '*'

  # 黑名单中所有*.google.com的URL
  - netloc: 'google.com'
  - netloc: '*.google.com'

  # 黑名单中所有普通HTTP URL
  - scheme: 'http'

  # 黑名单http(s)://www.acme.com/foo
  - netloc: 'www.acme.com'
    path: '/foo'

  # 黑名单中含有字面意义IPv4地址的任何URL
  - netloc: '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'
```
---
### `max_spider_size`
允许的最大URL预览爬虫数据大小，以字节为单位。默认为10M。

示例配置:
```yaml
max_spider_size: 8M
```
---
### `url_preview_accept_language`
下载网页期间，用于URL预览生成时的HTTP头Accept-Language值列表。此选项允许Synapse在与远程服务器通信时指定URL预览所应使用的首选语言。

每个值是一个IETF语言标记；2-3个字母的标识符，可以选择性地随附以-分隔的子标签，指定国家或区域变体。

可以提供多个值，每个值可以通过使用质量值语法(;q=)加权。'*'表示任何语言。

默认为“en”。

示例配置:
```yaml
 url_preview_accept_language:
   - 'en-UK'
   - 'en-US;q=0.9'
   - 'fr;q=0.8'
   - '*;q=0.7'

```
---
### `oembed`
oEmbed便于从网站中嵌入内容。它可用于生成支持服务的URL预览。Synapse包含默认的oEmbed提供者列表。设置`disable_default_providers`为true以禁用使用这些默认的oEmbed URL。使用`additional_providers`指定具有oEmbed配置的额外文件（每个文件应采用providers.json格式）。默认情况下该列表为空。

示例配置:
```yaml
oembed:
  disable_default_providers: true
  additional_providers:
    - oembed/my_providers.json
```
---
## Captcha
完整的验证码设置详情见[这里](../../CAPTCHA_SETUP.md)。

---
### `recaptcha_public_key`
此服务器的ReCAPTCHA公钥。如果启用了[`enable_registration_captcha`](#enable_registration_captcha)，必须指定。

示例配置:
```yaml
recaptcha_public_key: "YOUR_PUBLIC_KEY"

```
---
### `recaptcha_private_key`
此服务器的ReCAPTCHA私钥。如果启用了[`enable_registration_captcha`](#enable_registration_captcha)，必须指定。

示例配置:
```yaml
recaptcha_private_key: "YOUR_PRIVATE_KEY"

```
---
### `enable_registration_captcha`
设置为`true`以在用户注册帐户时要求完成CAPTCHA测试。需要有效的ReCaptcha公钥/私钥。默认为`false`。

请注意，[`enable_registration`](#enable_registration)也必须设置为允许帐户注册。

示例配置:
```yaml
enable_registration_captcha: true
```
---
### `recaptcha_siteverify_api`
用于验证`m.login.recaptcha`响应的API终端。默认为`https://www.recaptcha.net/recaptcha/api/siteverify`。

示例配置:
```yaml
recaptcha_siteverify_api: "https://my.recaptcha.site"

```
---
## TURN
对在Synapse中添加TURN服务器的选项。

---
### `turn_uris`
提供给客户的TURN服务器的公共URI。

示例配置:
```yaml
turn_uris: [turn:example.org]
```
---
### `turn_shared_secret`
用于计算TURN服务器密码的共享密钥。

示例配置:
```yaml
turn_shared_secret: "YOUR_SHARED_SECRET"

```
---
### `turn_shared_secret_path`
[`turn_shared_secret`](#turn_shared_secret)的替代方案：允许在外部文件中指定共享密钥。

该文件应为纯文本文件，仅包含共享密钥。Synapse在启动时从给定文件中读取共享密钥。

示例配置:
```yaml
turn_shared_secret_path: /path/to/secrets/file
```

_在Synapse 1.116.0中添加。_

---
### `turn_username` 和 `turn_password`
如果TURN服务器需要它们且不使用令牌，则使用的用户名和密码。

示例配置:
```yaml
turn_username: "TURNSERVER_USERNAME"
turn_password: "TURNSERVER_PASSWORD"

```
---
### `turn_user_lifetime`
生成的TURN凭证的有效时长。默认为1小时。

示例配置:
```yaml
turn_user_lifetime: 2h
```
---
### `turn_allow_guests`
是否允许访客使用TURN服务器。默认值为true，否则VoIP对访客将不可靠。然而，这确实引入了一点安全风险，因为它允许用户在未先注册有效帐户（例如通过CAPTCHA）的情况下连接到任意端点。

示例配置:
```yaml
turn_allow_guests: false
```
---
## Registration ##
注册可以使用本手册[Ratelimiting](#ratelimiting)部分中的参数进行速率限制。

---
### `enable_registration`
启用新用户注册。默认为`false`。

强烈建议如果启用注册，设置一个或多个以下选项，以避免您的服务器被"机器人"滥用：

 * [`enable_registration_captcha`](#enable_registration_captcha)
 * [`registrations_require_3pid`](#registrations_require_3pid)
 * [`registration_requires_token`](#registration_requires_token)
（为了启用没有任何验证的注册，还必须设置[`enable_registration_without_verification`](#enable_registration_without_verification)。）
请注意，即使此设置被禁用，如果设置了[`registration_shared_secret`](#registration_shared_secret)，通过admin API仍然可以创建新帐户。

示例配置:
```yaml
enable_registration: true
```
---
### `enable_registration_without_verification`
启用无电子邮件或验证码验证的注册。注意：此选项*不*建议使用，因为没有验证的注册已知是垃圾邮件和滥用的途径。默认为`false`。没有效果，除非[`enable_registration`](#enable_registration)也启用。

示例配置:
```yaml
enable_registration_without_verification: true
```
---
### `registrations_require_3pid`
如果设置此项，用户在注册帐户时必须提供所有指定类型的[3PID](https://spec.matrix.org/latest/appendices/#3pid-types)。

注意，[`enable_registration`](#enable_registration)也必须设置为允许帐户注册。

示例配置:
```yaml
registrations_require_3pid:
  - email
  - msisdn
```
---
### `disable_msisdn_registration`
明确禁用在注册流程中询问MSISDN（如果已将MSISDN设置为必需，该设置将覆盖`registrations_require_3pid`）。

示例配置:
```yaml
disable_msisdn_registration: true
```
---
### `allowed_local_3pids`
要求用户只能将指定格式的3PID与此服务器上的帐户关联，如通过`medium`和`pattern`子选项所规定的。`pattern`是一个[类Perl的正则表达式](https://docs.python.org/3/library/re.html#module-re)。

有关3PID、允许的`medium`类型及其`address`语法的更多信息，请参阅[Matrix spec](https://spec.matrix.org/latest/appendices/#3pid-types)。

示例配置:
```yaml
allowed_local_3pids:
  - medium: email
    pattern: '^[^@]+@matrix\.org$'
  - medium: email
    pattern: '^[^@]+@vector\.im$'
  - medium: msisdn
    pattern: '^44\d{10}$'

```
---
### `enable_3pid_lookup`
启用此服务器对身份服务器的3PID查找请求。默认为true。

示例配置:
```yaml
enable_3pid_lookup: false
```
---
### `registration_requires_token`
要求用户在注册期间提交一个令牌。可以使用管理[API](../administration/admin_api/registration_tokens.md)管理令牌。禁用此选项不会删除任何先前生成的令牌。默认为`false`。设置为`true`以启用。

注意，[`enable_registration`](#enable_registration)也必须设置为允许帐户注册。

示例配置:
```yaml
registration_requires_token: true
```
---
### `registration_shared_secret`
如果设置，允许任何持有共享密钥的人注册标准或管理帐户，即使没有设置[`enable_registration`](#enable_registration)。

这主要用于`register_new_matrix_user`脚本（参见[注册用户](../../setup/installation.md#registering-a-user)）；然而，该接口已[记录](../../admin_api/register_api.html)。

另见[`registration_shared_secret_path`](#registration_shared_secret_path)。

示例配置:
```yaml
registration_shared_secret: <PRIVATE STRING>
```
---
### `registration_shared_secret_path`
[`registration_shared_secret`](#registration_shared_secret)的替代方案：允许在外部文件中指定共享密钥。

该文件应为纯文本文件，仅包含共享密钥。

如果此文件不存在，Synapse将创建一个新的共享密钥，并在启动时将其存储在此文件中。

示例配置:
```yaml
registration_shared_secret_path: /path/to/secrets/file
```
_在Synapse 1.67.0中添加。_

---
### `bcrypt_rounds`
设置用于生成密码哈希的bcrypt轮数。较大的数字会增加生成哈希所需的工作因数。默认轮数为12（相当于2^12轮）。注意，增加此值会以指数速度增加注册或登录所需的时间 - 例如24 => 2^24轮将需要超过20分钟。

示例配置:
```yaml
bcrypt_rounds: 14
```
---
### `allow_guest_access`
允许用户以访客身份注册，无需密码/电子邮件等，并参加此服务器上已对匿名用户开放的房间。默认为false。

示例配置:
```yaml
allow_guest_access: true
```
---
### `default_identity_server`
我们建议用户在此服务器上登录时应该使用的身份服务器。

（默认情况下，没有建议，因此由客户端决定。此设置被忽略，除非`public_baseurl`也显式设置。）
示例配置:
```yaml
default_identity_server: https://matrix.org
```
---
### `account_threepid_delegates`
将电话号码验证委托给身份服务器。

当用户希望将电话号码添加到他们的帐户时，我们需要验证他们确实拥有该手机号，这需要发送一条短信（SMS）。目前Synapse不支持自己发送这些短信，而是将此任务委托给身份服务器。所使用身份服务器的基本URI由`account_threepid_delegates.msisdn`选项指定。

如果没有指定，Synapse将不允许用户将电话号码添加到他们的帐户。

（处理这些请求的服务器必须回答Matrix Identity Service API概述的`/requestToken`端点请求[规范说明](https://matrix.org/docs/spec/identity_service/latest)。）
_在Synapse 1.64.0中弃用_：`email`选项已弃用。

_在Synapse 1.66.0中移除_：`email`选项已被移除。若存在，Synapse将在启动时报告配置错误。

示例配置:
```yaml
account_threepid_delegates:
    msisdn: http://localhost:8090  # 将短信发送委托给此本地进程
```
---
### `enable_set_displayname`
允许用户在初次设置后更改其显示名称。基于第三方目录内容进行用户预配时很有用。

不适用于服务器管理员。默认为true。

示例配置:
```yaml
enable_set_displayname: false
```
---
### `enable_set_avatar_url`
允许用户在初次设置后更改其头像。基于第三方目录内容进行用户预配时很有用。

不适用于服务器管理员。默认为true。

示例配置:
```yaml
enable_set_avatar_url: false
```
---
### `enable_3pid_changes`
是否允许用户更改与其帐户关联的第三方ID（电子邮件地址和msisdn）。

默认为true。

示例配置:
```yaml
enable_3pid_changes: false
```
---
### `auto_join_rooms`
在此服务器上注册的用户将自动加入在此选项下列出的房间。

默认情况下，此列表中包含的任何房间别名将在homeserver上第一个用户注册时作为公开可加入房间创建。如果房间已经存在，请确保它是可公开加入的房间，即房间的加入规则必须设置为“公开”。有关自动加入房间的更多选项见下文。

由于空间在底层也是房间，因此也可以使用空间别名。

示例配置:
```yaml
auto_join_rooms:
  - "#exampleroom:example.com"

  - "#anotherexampleroom:example.com"

```
---
### `autocreate_auto_join_rooms`
在`auto_join_rooms`指定的情况下，设置此标志确保这些房间在homeserver上第一个用户注册时通过创建它们而存在。此选项不会创建空间。

默认情况下，自动创建的房间可从任何联邦服务器公开加入。使用`autocreate_auto_join_rooms_federated`和`autocreate_auto_join_room_preset`设置自定义此行为。

设置为false表示如果房间未手动创建，用户无法被自动加入，因为它们不存在。

默认为true。

示例配置:
```yaml
autocreate_auto_join_rooms: false
```
---
### `autocreate_auto_join_rooms_federated`
自动创建的在`auto_join_rooms`中列出的房间是否可通过联合访问。仅在`autocreate_auto_join_rooms`为真时报有效果。

请注意，房间创建后，其联合可访问性不能更改。

默认为true：房间可被来自其他服务器的用户加入。设置为false可防止其他homeserver用户加入这些房间。

示例配置:
```yaml
autocreate_auto_join_rooms_federated: false
```
---
### `autocreate_auto_join_room_preset`
自动创建`auto_join_rooms`房间时使用的房间预设。仅在`autocreate_auto_join_rooms`为真时生效。

此选项可能的值有:
* "public_chat": 房间对任何人（包括联合服务器，如果`autocreate_auto_join_rooms_federated`为真）开放加入（默认）。
* "private_chat": 加入这些房间需要邀请。
* "trusted_private_chat": 加入此房间需要邀请，且受邀者在加入后分配权级为100。

每个预设将以与调用时提供为`preset`参数相同的方式设置房间数据
[`POST /_matrix/client/v3/createRoom`](https://spec.matrix.org/latest/client-server-api/#post_matrixclientv3createroom)客户端-服务器API端点。

如果使用“private_chat”或“trusted_private_chat”的值，那么也必须配置`auto_join_mxid_localpart`。

默认为“public_chat”。

示例配置:
```yaml
autocreate_auto_join_room_preset: private_chat
```
---
### `auto_join_mxid_localpart`
当`autocreate_auto_join_rooms`为真时，创建`auto_join_rooms`房间所使用的用户id的本地部分。如果未提供，则将使用注册的第一个用户帐户创建这些房间。

该用户id也用于邀请新用户加入任何设置为仅限邀请的自动加入房间。

如果设置了`autocreate_auto_join_room_preset`为“private_chat”或“trusted_private_chat”，则必须配置。

请注意，若已有房间，该用户必须加入并拥有邀请新成员的适当权限。

示例配置:
```yaml
auto_join_mxid_localpart: system
```
---
### `auto_join_rooms_for_guests`
当指定`auto_join_rooms`时，设置此标志为false可阻止访客帐户被自动加入这些房间。

默认为true。

示例配置:
```yaml
auto_join_rooms_for_guests: false
```
---
### `inhibit_user_in_use_error`
是否抑制当注册新帐户时用户ID已存在时产生的错误。如果开启，向`/register/available`发出的请求将始终显示用户ID可用，而在使用已存在用户名完成注册时Synapse不会引发错误。

默认为false。

示例配置:
```yaml
inhibit_user_in_use_error: true
```

---
## 用户会话管理
---
### `session_lifetime`
用户登录后，会话保持有效的时间。

注意，此功能当前与访客登录不兼容。

还需注意，此时间是在登录时计算的：对于已登录的用户，变更不会追溯应用。

默认情况下，这是无限的。

配置示例：

```yaml
session_lifetime: 24h
```
---
### `refreshable_access_token_lifetime`
如果会话使用刷新令牌，访问令牌保持有效的时间。

有关刷新令牌的更多信息，请参阅[手册](Synapse%20Docs%20-%20EN/usage/configuration/user_authentication/refresh_tokens.md)。

注意，这仅适用于宣布支持刷新令牌的客户端。

还需注意，此时间是在登录和刷新时计算的：对于现有会话，变更不会应用，直到会话被刷新。

默认情况下，这是5分钟。

配置示例：

```yaml
refreshable_access_token_lifetime: 10m
```
---
### `refresh_token_lifetime`
刷新令牌保持有效的时间（前提是它未被交换为另一个令牌）。

此选项可用于自动注销不活跃的会话。

更多信息请参阅手册。

还需注意，此时间是在登录和刷新时计算的：对于现有会话，变更不会应用，直到会话被刷新。

默认情况下，这是无限的。

配置示例：

```yaml
refresh_token_lifetime: 24h
```
---
### `nonrefreshable_access_token_lifetime`
如果会话**不**使用刷新令牌，访问令牌保持有效的时间。

请注意，并非所有客户端都支持刷新令牌，因此将此设置为较短的值可能会对某些用户造成不便，他们将会频繁注销。

还需注意，此时间是在登录时计算的：对已登录用户的现有会话，变更不会追溯应用。

默认情况下，这是无限的。

配置示例：

```yaml
nonrefreshable_access_token_lifetime: 24h
```
---
### `ui_auth`
允许用户交互式认证会话活动的时间量。

默认值为0，意味着每次操作前均会查询用户凭证，但可以覆盖此设置以允许重复使用一次验证。这会削弱用户交互式认证过程提供的保护，因为允许多个（并且可能是不同的）操作使用相同验证会话。

对于可能“危险”的操作（包括停用账户、修改账户密码、添加3PID和生成额外登录令牌），此设置会被忽略。

使用`session_timeout`子选项更改允许凭证验证的时间。

配置示例：

```yaml
ui_auth:
    session_timeout: "15s"

```
---
### `login_via_existing_session`
Matrix支持使用现有会话为其他客户端生成登录令牌的功能。

默认情况下，Synapse禁用此功能，因为它具有安全隐患——恶意客户端可能使用该机制生成多个会话。

生成的令牌的有效持续时间可以通过`token_timeout`子选项进行配置。

启用此功能时，除非`require_ui_auth`子选项设置为`False`，否则需要用户交互式认证。

配置示例：

```yaml
login_via_existing_session:
    enabled: true
    require_ui_auth: false
    token_timeout: "5m"

```
---
## 指标
与指标相关的配置选项。

---
### `enable_metrics`
设置为true以启用性能指标的收集和渲染。

默认值为false。

配置示例：

```yaml
enable_metrics: true
```
---
### `sentry`
使用该选项启用Sentry集成。通过`dsn`设置提供由Sentry分配给您的DSN。

可以使用可选的`environment`字段指定环境。这可基于不同的环境进行日志维护，确保更好的组织和分析。

注意：尽管尝试确保日志不包含任何敏感信息，但无法保证这一点。通过启用此选项，Sentry服务器可能会因此接收到敏感信息，并可能通过不安全的通知渠道传播这些敏感信息（如果此类配置）。

配置示例：

```yaml
sentry:
    environment: "production"

    dsn: "..."

```
---
### `metrics_flags`
用于启用默认情况下不适合启用Prometheus指标的标志，可能是出于性能原因，或用处有限。当前唯一的选项是`known_servers`，它发布`synapse_federation_known_servers`，即此home服务器知道的服务器数量的标志(包括其本身)。在大型home服务器上可能会导致性能问题。

配置示例：

```yaml
metrics_flags:
    known_servers: true
```
---
### `report_stats`
是否报告home服务器使用统计。最初是在生成配置时设置的。设置此选项为true或false以更改当前行为。请参阅[报告home服务器使用统计](../administration/monitoring/reporting_homeserver_usage_statistics.md)以获取有关所报告数据的信息。

Synapse启动后5分钟会报告统计，然后每3小时报告一次。

配置示例：

```yaml
report_stats: true
```
---
### `report_stats_endpoint`
用于报告home服务器使用统计的端点。

默认为https://matrix.org/report-usage-stats/push
配置示例：

```yaml
report_stats_endpoint: https://example.com/report-usage-stats/push
```
---
## API配置
与客户端/服务器API有关的配置设置
---
### `room_prejoin_state`
此设置控制在接收房间邀请或回应敲门请求时与用户共享的状态。默认情况下，与用户共享以下状态事件：

- `m.room.join_rules`
- `m.room.canonical_alias`
- `m.room.avatar`
- `m.room.encryption`
- `m.room.name`
- `m.room.create`
- `m.room.topic`
要更改默认行为，请使用以下子选项：

* `disable_default_event_types`: 布尔值。设置为`true`以禁用上述默认设置。如果启用此选项，则仅共享`additional_event_types`中列出的事件类型。默认值为`false`。
* `additional_event_types`: 要在共享的事件中包含的额外状态事件的列表。默认情况下，此列表为空（因此仅共享默认事件类型）。

  此列表中的每个条目应该是一个字符串或两个字符串的列表。

  * 独立的字符串`t`代表所有类型为`t`的事件（即无状态键限制）。
  * 字符串对`[t, s]`代表类型为`t`且状态键为`s`的单个事件。相同类型的事件可以在两个条目中出现具有不同的状态键：在这种情况下，两个状态键都将包括在预加入状态中。

配置示例：

```yaml
room_prejoin_state:
   disable_default_event_types: false
   additional_event_types:
     # 共享类型为`org.example.custom.event.typeA`的所有事件
     - org.example.custom.event.typeA
     # 仅共享类型为`org.example.custom.event.typeB`且状态键为"foo"的事件
     - ["org.example.custom.event.typeB", "foo"]
     # 仅共享类型为`org.example.custom.event.typeC`且状态键为"bar"或"baz"的事件
     - ["org.example.custom.event.typeC", "bar"]
     - ["org.example.custom.event.typeC", "baz"]
```
*Synapse 1.74中的更改：*管理员可以根据状态键过滤预加入状态中的事件。

---
### `track_puppeted_user_ips`
我们记录用于访问API的客户端IP地址，出于各种原因，包括在“您登录的位置”对话框中显示给用户。

默认情况下，通过admin API代理其他用户时，客户端IP地址记录在创建访问令牌的用户（即管理员用户）名下，而**不是**代理的用户。

将此选项设置为true以便IP地址也记录在代理用户名下。（这也意味着代理用户将被视为“活跃”用户，用于每月活跃用户跟踪-请参见上方的`limit_usage_by_mau`等。）
配置示例：

```yaml
track_puppeted_user_ips: true
```
---
### `app_service_config_files`
要使用的应用程序服务配置文件的列表。

配置示例：

```yaml
app_service_config_files:
  - app_service_1.yaml
  - app_service_2.yaml
```
---
### `track_appservice_user_ips`
默认为false。设置为true以启用对应用程序服务IP地址的跟踪。

隐式启用应用程序服务用户的MAU跟踪。

配置示例：

```yaml
track_appservice_user_ips: true
```
---
### `use_appservice_legacy_authorization`
是否通过`access_token`查询参数发送应用程序服务访问令牌
符合Matrix规范的旧版本。默认为false。设置为true以启用通过查询参数发送访问令牌。

**启用此选项被视为不安全且不推荐。**
配置示例：

```yaml
use_appservice_legacy_authorization: true
```
---
### `macaroon_secret_key`
用于签名的密钥
- 访客用户访问令牌，
- 在SSO登录（OIDC或SAML2）期间使用的短期登录令牌和
- 用于取消接收邮件通知的令牌。

如果未指定此密钥，将使用`registration_shared_secret`，如果存在；

否则，将从签名密钥中派生一个秘密密钥。

配置示例：

```yaml
macaroon_secret_key: <PRIVATE STRING>
```
---
### `form_secret`
用于计算表单值HMAC的密钥，以防止值的伪造。必须指定以使用户同意
表单正常工作。

配置示例：

```yaml
form_secret: <PRIVATE STRING>
```
---
## 签名密钥
与签名密钥相关的配置选项
---
### `signing_key_path`
用于签署事件和联邦请求的签名密钥的路径。

*Synapse 1.67中的新增功能*：如果此文件不存在，Synapse将在启动时创建新签名密钥，并将其存储在此文件中。

配置示例：

```yaml
signing_key_path: "CONFDIR/SERVERNAME.signing.key"

```
---
### `old_signing_keys`
服务器用于签署消息但不用于签署新消息的密钥。对于每个密钥，`key`应为base64编码的公钥，`expired_ts`应为自Unix纪元以来最后使用的时间（毫秒）。

可以使用与synapse一起提供的`export_signing_key`脚本从旧的`signing.key`文件中构建一个条目。

配置示例：

```yaml
old_signing_keys:
  "ed25519:id": { key: "base64string", expired_ts: 123456789123 }
```
---
### `key_refresh_interval`
由此服务器发布的密钥响应的有效期。

用于在`/key/v2` APIs中设置`valid_until_ts`。

决定服务器查询以检查哪些密钥有效的频率。默认为1天。

配置示例：

```yaml
key_refresh_interval: 2d
```
---
### `trusted_key_servers`
用于下载签名密钥的可信服务器。

当我们需要获取签名密钥时，每个服务器都是并行尝试的。

通常，通过TLS证书验证与密钥服务器的连接。

可以通过配置`verify key`来提供额外的安全性，这将使Synapse检查响应是否由该密钥签署。

此设置取代旧的名为`perspectives`的设置。旧格式仍然支持以保持向后兼容，但已被弃用。

`trusted_key_servers`默认为matrix.org，但使用它将在启动时产生警告。要抑制此警告，请将`suppress_key_server_warning`设置为true。

如果必须停用可信密钥服务器的使用，例如在私人联盟中或出于隐私原因，这可以通过设置空数组（`trusted_key_servers: []`）来实现。然后，Synapse将直接从拥有密钥的服务器请求密钥。如果Synapse无法直接从服务器获取密钥，则此服务器的事件将被拒绝。

列表中每个条目的选项包括：

* `server_name`: 服务器名称。必填。
* `verify_keys`: 一个可选的从密钥ID到base64编码的公钥的映射。

   如果指定，我们将检查响应是否由所提供密钥中的至少一个签署。

* `accept_keys_insecurely`: 布尔值。通常，如果`verify_keys`未设置，且`federation_verify_certificates`不为`true`，Synapse将拒绝启动，因为这将允许任何能够伪造DNS响应的人假冒可信密钥服务器。如果您知道自己在做什么，并确定您的网络环境提供一个安全的连接到密钥服务器，您可以设置此项为`true`以覆盖此行为。

配置示例#1：

```yaml
trusted_key_servers:
  - server_name: "my_trusted_server.example.com"

    verify_keys:
      "ed25519:auto": "abcdefghijklmnopqrstuvwxyzabcdefghijklmopqr"

  - server_name: "my_other_trusted_server.example.com"

```
配置示例#2：

```yaml
trusted_key_servers:
  - server_name: "matrix.org"

```
---
### `suppress_key_server_warning`
设置以下值为true以禁用当`trusted_key_servers`包含'matrix.org'时发出的警告。请参阅上文。

配置示例：

```yaml
suppress_key_server_warning: true
```
---
### `key_server_signing_keys_path`
作为可信密钥服务器使用时使用的签名密钥。如果未指定，则默认为服务器签名密钥。

可以包含多个密钥，每行一个。

配置示例：

```yaml
key_server_signing_keys_path: "key_server_signing_keys.key"

```
---
## 单点登录集成
以下设置可以使Synapse使用单点登录提供程序进行认证，而不是其内部密码数据库。

您可能还想将以下选项设置为`false`以禁用常规登录/注册流程：

   * [`enable_registration`](#enable_registration)
   * [`password_config.enabled`](#password_config)
---
### `saml2_config`
启用SAML2用于注册和登录。使用pysaml2。要了解有关pysaml的更多信息并找完整列表的选项，阅读文档[此处](https://pysaml2.readthedocs.io/en/latest/)。

至少必须在此节中设置`sp_config`或`config_path`之一以启用SAML登录。您可以使用`sp_config`选项在线插入完整的pysaml配置，或者可以使用子选项`config_path`指定一个psyaml配置文件的路径。

此设置具有以下子选项：

* `idp_name`: 此身份提供者的用户界面名称，用于为用户提供登录机制的选择。
* `idp_icon`: 此身份提供者的可选图标，由客户端和Synapse自己的IdP选择页面呈现。如果给出，必须是格式为`mxc://<server-name>/<media-id>`的MXC URI。（获取此类MXC URI的简便方法是在某个（未加密的）房间中上传一张图片，然后从事件源中复制“url”。）
* `idp_brand`: 此身份提供者的可选品牌，使客户端根据特定的身份提供者调整登录流程样式。

   有关可能的选项，请参阅[规范](https://spec.matrix.org/latest/)。

* `sp_config`: pysaml2服务提供者的配置。有关配置格式，请参阅pysaml2文档。

   默认为`entityid`和`service`设置使用默认值，因此通常不需要指定，除非您需要覆盖它们。这里有一些用于配置pysaml的有用子选项：

   * `metadata`: 指向IdP的元数据。您必须通过`local`属性提供一个本地文件，或（首选）通过`remote`属性提供一个URL。
   * `accepted_time_diff: 3`: 允许的home服务器与IdP之间的时钟差（以秒为单位）。

      默认为0。

   * `service`: 默认情况下，用户必须首先访问我们的登录页面。如果您希望允许IdP发起的登录，请在`service`部分的`sp`中将`allow_unsolicited`设置为true。
* `config_path`: 可以通过如下方式指定一个独立的pysaml2配置文件：

  `config_path: "CONFDIR/sp_conf.py"`
* `saml_session_lifetime`: SAML会话的寿命。这定义了用户必须完成认证过程的时间（如果`allow_unsolicited`未设置）。默认为15分钟。
* `user_mapping_provider`: 使用此选项，可以提供一个外部模块作为自定义解决方案，将从saml提供者返回的属性映射到matrix用户。`user_mapping_provider`具有以下属性：
  * `module`: 自定义模块的类。
  * `config`: 模块的自定义配置值。如果您使用内建的user_mapping_provider，请使用示例中提供的值，或者如果您使用的是自定义类，则提供您自己的配置值。

     此部分将作为Python字典传递给模块的`parse_config`方法。内建提供者接受以下两个选项：

      * `mxid_source_attribute`: 用于从中派生Matrix ID的SAML属性（在通过属性映射后）。默认值为'uid'。注意：这过去是通过`saml2_config.mxid_source_attribute选项`进行配置的。如果仍然定义了该选项，则将使用其值。
      * `mxid_mapping`: 用于将saml属性映射到matrix ID的映射系统。选项包括：`hexencode`（将不允许的字符映射为'=xx'）和`dotreplace`（将不允许的字符替换为'.'）。默认值为`hexencode`。注意：这过去是通过`saml2_config.mxid_mapping选项`进行配置的。如果它仍然定义了，则将使用其值。
* `grandfathered_mxid_source_attribute`: 在之前的synapse版本中，SAML属性到MXID的映射总是动态计算的，而不是存储在表中。为了向后兼容，我们将在创建新帐户之前寻找匹配此模式的`user_ids`。

   此设置控制将用于此向后兼容性查找的SAML属性。通常应为'uid'，但如果属性映射已更改，可能需要更改它。默认值为'uid'。

* `attribute_requirements`: 可以将Synapse配置为仅在SAML属性匹配特定值时允许登录。

    可以按如下例在`attribute_requirements`下列出这些要求。列出的所有属性必须匹配，登录才被允许。

* `idp_entityid`: 如果元数据XML包含多个IdP实体，则必须设置`idp_entityid`选项为要重定向用户的实体。

   大多数部署只包含一个IdP实体，因此应省略此选项。

启用 SAML 支持后，将在 `https://<server>:<port>/_synapse/client/saml2/metadata.xml` 处提供一个元数据文件，您可以用来配置您的 SAML IdP。或者，您可以手动配置 IdP 以使用 ACS 位置 `https://<server>:<port>/_synapse/client/saml2/authn_response`。

示例配置：

```yaml
saml2_config:
saml2_config:
  sp_config:
    metadata:
      local: ["saml2/idp.xml"]
      remote:
        - url: https://our_idp/metadata.xml
    accepted_time_diff: 3

    service:
      sp:
        allow_unsolicited: true

     # 以下示例仅用于生成我们的元数据 xml，具体设置可能根据您的部署不同而有所改变。或者您可能需要详细信息丰富配置 - 请参阅pysaml2文档！
    description: ["My awesome SP", "en"]
    name: ["Test SP", "en"]

    ui_info:
      display_name:
        - lang: en
          text: "Display Name is the descriptive name of your service."
      description:
        - lang: en
          text: "Description should be a short paragraph explaining the purpose of the service."
      information_url:
        - lang: en
          text: "https://example.com/terms-of-service"
      privacy_statement_url:
        - lang: en
          text: "https://example.com/privacy-policy"
      keywords:
        - lang: en
          text: ["Matrix", "Element"]
      logo:
        - lang: en
          text: "https://example.com/logo.svg"
          width: "200"
          height: "80"

    organization:
      name: Example com
      display_name:
        - ["Example co", "en"]
      url: "http://example.com"

    contact_person:
      - given_name: Bob
        sur_name: "the Sysadmin"
        email_address: ["admin@example.com"]
        contact_type: technical

  saml_session_lifetime: 5m

  user_mapping_provider:
        # 以下选项用于内置提供程序，如果使用自定义模块，应进行更改。
    config:
      mxid_source_attribute: displayName
      mxid_mapping: dotreplace

  grandfathered_mxid_source_attribute: upn

  attribute_requirements:
    - attribute: userGroup
      value: "staff"
    - attribute: department
      value: "sales"

  idp_entityid: 'https://our_idp/entityid'

```

### `oidc_providers`

OpenID Connect (OIDC) / OAuth 2.0 身份提供商列表，用于注册和登录。有关如何配置这些选项的信息，请参见[此处](../../openid.md)。

为了向后兼容，也可以通过 `oidc_config` 设置配置单个 OIDC 提供商。这种方式现已弃用，建议管理员迁移到 `oidc_providers` 格式。（在进行迁移时，使用 `oidc` 作为 `idp_id`，以确保现有用户继续被识别。）

每个条目的选项包括：
* `idp_id`：此身份提供商的唯一标识符。由 Synapse 内部使用；应为单个词，例如 'github'。
  请注意，如果更改此项，通过该提供商进行身份验证的用户将不再被识别为同一用户！
  （如果从旧的 `oidc_config` 配置迁移，请在此处使用 "oidc"。）

* `idp_name`：此身份提供商的用户界面名称，用于为用户提供登录机制的选择。

* `idp_icon`：此身份提供商的可选图标，由客户端和 Synapse 自己的 IdP 选择页面呈现。如果提供，必须是格式为 `mxc://<server-name>/<media-id>` 的 MXC URI。（获取此类 MXC URI 的一种简单方法是将图像上传到（未加密的）房间，然后从事件源中复制 "url"。）

* `idp_brand`：此身份提供商的可选品牌，允许客户端根据相关身份提供商样式化登录流程。有关可能的选项，请参见[规范](https://spec.matrix.org/latest/)。

* `discover`：设置为 false 以禁用使用 OIDC 发现机制来发现端点。默认为 true。

* `issuer`：必需。OIDC 发行者。用于验证令牌，并（如果启用了发现）发现提供商的端点。

* `client_id`：必需。要使用的 oauth2 客户端 ID。

* `client_secret`：要使用的 oauth2 客户端密钥。如果给出了 `client_secret_jwt_key`，或者 `client_auth_method` 为 'none'，可以省略。必须省略如果指定了 `client_secret_path`。

* `client_secret_path`：要使用的 oauth2 客户端密钥的路径。这样就不需要将密钥泄露到配置文件本身。与 `client_secret` 互斥。如果指定了 `client_secret_jwt_key`，可以省略。

   *在 Synapse 1.91.0 中添加。*

* `client_secret_jwt_key`：client_secret 的替代方案：用于创建 JSON Web Token 以用作 OAuth2 客户端密钥的密钥详细信息。如果给出，必须是具有以下属性的字典：

  * `key`：pem 编码的签名密钥。必须是适合指定算法的密钥。除非给出了 `key_file`，否则必需。

  * `key_file`：包含 pem 编码签名密钥文件的文件路径。除非给出了 `key`，否则必需。

  * `jwt_header`：字典，给出要包含在 JWT 头中的属性。必须包括键 `alg`，给出用于签署 JWT 的算法，例如 "ES256"，使用 RFC7518 中的 JWA 标识符。

  * `jwt_payload`：可选字典，给出要包含在 JWT 负载中的属性。通常应包括一个 `iss` 键。

* `client_auth_method`：在交换令牌时使用的身份验证方法。有效值为 `client_secret_basic`（默认）、`client_secret_post` 和 `none`。

* `pkce_method`：在请求和交换令牌时是否使用代码交换的证明密钥。有效值为：`auto`、`always` 或 `never`。默认为 `auto`，如果在元数据发现期间支持，则使用 PKCE。设置为 `always` 强制启用 PKCE，或 `never` 强制禁用 PKCE。

* `scopes`：请求的范围列表。通常应包括 "openid" 范围。默认为 `["openid"]`。

* `authorization_endpoint`：oauth2 授权端点。如果禁用提供商发现，则必需。

* `token_endpoint`：oauth2 令牌端点。如果禁用提供商发现，则必需。

* `userinfo_endpoint`：OIDC 用户信息端点。如果禁用发现且未请求 'openid' 范围，则必需。

* `jwks_uri`：获取 JWKS 的 URI。如果禁用发现且使用 'openid' 范围，则必需。

* `skip_verification`：设置为 'true' 以跳过元数据验证。如果您连接到不符合 OpenID Connect 的提供商，请使用此选项。默认为 false。在生产中避免使用。

* `user_profile_method`：是否从用户信息端点获取用户配置文件，或依赖于从 `token_endpoint` 返回的 id_token 中的数据。有效值为：`auto` 或 `userinfo_endpoint`。默认为 `auto`，如果 `openid` 未包含在 `scopes` 中，则使用用户信息端点。设置为 `userinfo_endpoint` 以始终使用用户信息端点。

* `additional_authorization_parameters`：将作为附加参数传递给授权授予 URL 的字符串到字符串字典。

* `allow_existing_users`：设置为 true 以允许通过 OIDC 登录的用户匹配预先存在的帐户而不是失败。如果从密码登录切换到 OIDC，可以使用此选项。默认为 false。

* `enable_registration`：设置为 'false' 以禁用新用户的自动注册。这允许 OIDC SSO 流程仅限于登录，而不是自动注册具有有效 SSO 登录但没有预注册帐户的用户。默认为 true。

* `user_mapping_provider`：配置如何将 OIDC 提供商返回的属性映射到矩阵用户。此设置具有以下子属性：

     * `module`：自定义映射模块的类名。默认是 `synapse.handlers.oidc.JinjaOidcMappingProvider`。
       有关实现自定义映射提供商的信息，请参见[OpenID 映射提供商](../../sso_mapping_providers.md#openid-mapping-providers)。

     * `config`：映射提供商模块的配置。此部分将作为 Python 字典传递给用户映射提供商模块的 `parse_config` 方法。

       对于默认提供商，可用以下设置：

       * `subject_template`：用户唯一标识符的 Jinja2 模板。默认为 `{{ user.sub }}`，OpenID Connect 合规提供商应提供。

         这将替换并覆盖 `subject_claim`。

       * `subject_claim`：包含用户唯一标识符的声明名称。默认为 'sub'，OpenID Connect 合规提供商应提供。

         *在 Synapse v1.75.0 中弃用。*

       * `picture_template`：用户个人资料图片 URL 的 Jinja2 模板。默认为 `{{ user.picture }}`，OpenID Connect 合规提供商应提供，并且必须指向直接图像文件，如 PNG、JPEG 或 GIF 图像文件。

         这将替换并覆盖 `picture_claim`。

         目前仅在单体（单进程）服务器配置中支持，其中媒体库在 Synapse 进程内运行。

       * `picture_claim`：包含用户个人资料图片 URL 的声明名称。默认为 'picture'，OpenID Connect 合规提供商应提供，并且必须指向直接图像文件，如 PNG、JPEG 或 GIF 图像文件。

         目前仅在单体（单进程）服务器配置中支持，其中媒体库在 Synapse 进程内运行。

         *在 Synapse v1.75.0 中弃用。*

       * `localpart_template`：MXID 的本地部分的 Jinja2 模板。如果未设置，用户将被提示选择自己的用户名（请参阅 `sso_auth_account_details.html` 模板的文档）。此模板可以使用 `localpart_from_email` 过滤器。

       * `confirm_localpart`：是否提示用户验证（或更改）生成的本地部分（请参阅 'sso_auth_account_details.html' 模板的文档），而不是立即注册帐户。

       * `display_name_template`：首次登录时设置的显示名称的 Jinja2 模板。如果未设置，则不会设置显示名称。

       * `email_template`：用户电子邮件地址的 Jinja2 模板。如果未设置，则不会将电子邮件地址添加到帐户。

       * `extra_attributes`：Jinja2 模板的映射，用于在登录期间发送回客户端的额外属性。请注意，这些是非标准的，客户端在没有修改的情况下会忽略它们。

     在渲染时，Jinja2 模板会得到一个 'user' 变量，该变量设置为用户信息端点和/或 ID 令牌返回的声明。

* `backchannel_logout_enabled`：设置为 `true` 以处理 OIDC 后通道注销通知。这些通知预计会在 `/_synapse/client/oidc/backchannel_logout` 上接收。默认为 `false`。

* `backchannel_logout_ignore_sub`：默认情况下，OIDC 后通道注销功能会检查 `sub` 声明是否与登录期间接收到的主题声明匹配。可以通过将此项设置为 `true` 来禁用此检查。默认为 `false`。

  如果映射提供商返回的 `subject_claim` 不是 `sub`，您可能需要禁用此项。

可以配置 Synapse 仅在某些属性与 OIDC 用户信息中的特定值匹配时才允许登录。可以在 `attribute_requirements` 下列出要求，如下所示：
```yaml
attribute_requirements:
     - attribute: family_name
       value: "Stephensson"
     - attribute: groups
       value: "admin"
```
所有列出的属性必须匹配才能允许登录。可以通过扩展 OIDC 配置的 `scopes` 部分来向用户信息添加额外属性，以从 OIDC 提供商检索额外信息。

如果 OIDC 声明是列表，则属性必须匹配列表中的任何值。否则，必须完全匹配声明的值。使用上面的示例，`family_name` 声明必须是 "Stephensson"，但 `groups` 声明必须包含 "admin"。

示例配置：
```yaml
oidc_providers:
  # 通用示例
  #
  - idp_id: my_idp
    idp_name: "My OpenID provider"
    idp_icon: "mxc://example.com/mediaid"
    discover: false
    issuer: "https://accounts.example.com/"
    client_id: "provided-by-your-issuer"
    client_secret: "provided-by-your-issuer"
    client_auth_method: client_secret_post
    scopes: ["openid", "profile"]
    authorization_endpoint: "https://accounts.example.com/oauth2/auth"
    token_endpoint: "https://accounts.example.com/oauth2/token"
    userinfo_endpoint: "https://accounts.example.com/userinfo"
    jwks_uri: "https://accounts.example.com/.well-known/jwks.json"
    additional_authorization_parameters:
      acr_values: 2fa
    skip_verification: true
    enable_registration: true
    user_mapping_provider:
      config:
        subject_claim: "id"
        localpart_template: "{{ user.login }}"
        display_name_template: "{{ user.name }}"
        email_template: "{{ user.email }}"
    attribute_requirements:
      - attribute: userGroup
        value: "synapseUsers"
```
---
### `cas_config`

启用中央认证服务（CAS）用于注册和登录。具有以下子选项：
* `enabled`：设置为 true 以启用对 CAS 服务器的授权。默认为 false。
* `idp_name`：此身份提供商的用户界面名称，用于为用户提供登录机制的选择。
* `idp_icon`：此身份提供商的可选图标，由客户端和 Synapse 自己的 IdP 选择页面呈现。如果提供，必须是格式为 `mxc://<server-name>/<media-id>` 的 MXC URI。（获取此类 MXC URI 的一种简单方法是将图像上传到（未加密的）房间，然后从事件源中复制 "url"。）
* `idp_brand`：此身份提供商的可选品牌，允许客户端根据相关身份提供商样式化登录流程。有关可能的选项，请参见[规范](https://spec.matrix.org/latest/)。
* `server_url`：CAS 授权端点的 URL。
* `protocol_version`：CAS 协议版本，默认为无（如果要使用 "required_attributes"，则需要版本 3）。
* `displayname_attribute`：CAS 响应中用作显示名称的属性。如果此处未给出名称，则不会设置显示名称。
* `required_attributes`：可以配置 Synapse 仅在 CAS 属性与特定值匹配时才允许登录。下面给出的所有键必须存在，并且值必须与给定值匹配。或者，如果给定值为 `None`，则允许任何值（属性只需存在即可）。所有列出的属性必须匹配才能允许登录。
* `enable_registration`：设置为 'false' 以禁用新用户的自动注册。这允许 CAS SSO 流程仅限于登录，而不是自动注册具有有效 SSO 登录但没有预注册帐户的用户。默认为 true。
* `allow_numeric_ids`：设置为 'true' 允许数字用户 ID（默认为 false）。这允许 CAS SSO 流程提供仅由数字组成的用户 ID。这些标识符默认会以字母 "u" 为前缀。可以使用 "numeric_ids_prefix" 选项配置前缀。请小心选择前缀以避免任何可能的冲突（例如，当用户 u1234 已存在时，用户 1234 变为 u1234）。
* `numeric_ids_prefix`：当 "allow_numeric_ids" 选项设置为 "true" 时，您希望在数字用户 ID 前添加的前缀。默认情况下，前缀是字母 "u"，并且只允许字母数字字符。

   *在 Synapse 1.93.0 中添加。*

示例配置：
```yaml
cas_config:
  enabled: true
  server_url: "https://cas-server.com"
  protocol_version: 3
  displayname_attribute: name
  required_attributes:
    userGroup: "staff"
    department: None
  enable_registration: true
  allow_numeric_ids: true
  numeric_ids_prefix: "numericuser"
```
---
### `sso`

用于 OpenID Connect、SAML2 和 CAS 等单点登录系统的附加设置。

服务器管理员可以为与 SSO 相关的页面配置自定义模板。有关更多信息，请参见[此处](../../templates.md)。

选项包括：
* `client_whitelist`：客户端 URL 的白名单列表，以便用户无需确认即可将其帐户访问权限授予该 URL。任何 URL 以以下列表中的条目开头的客户端在 SSO 登录完成后将不受额外确认步骤的限制。
  警告：像 "https://my.client" 这样的条目是不安全的，因为它也会匹配 "https://my.client.evil.site"，使您的用户容易受到来自 evil.site 的网络钓鱼攻击。为避免这种情况，请在主机名后面加上斜杠："https://my.client/"。
  登录回退页面（用于不原生支持所需登录流程的客户端）除了此列表中的任何 URL 外，还被列入白名单。默认情况下，此列表仅包含登录回退页面。
* `update_profile_information`：使用此设置可使用户的配置文件字段与身份提供商的信息保持同步。目前仅支持同步显示名称。在每次 SSO 登录时检查字段，并在必要时更新。
  请注意，启用此选项将覆盖用户配置文件信息，无论用户在首次登录时是否选择不同步该信息。默认为 false。

示例配置：
```yaml
sso:
    client_whitelist:
      - https://riot.im/develop
      - https://my.custom.client/
    update_profile_information: true
```
---
### `jwt_config`

JSON Web Token 集成。以下设置可用于使 Synapse 使用 JSON Web Token 进行身份验证，而不是其内部密码数据库。

每个 JSON Web Token 需要包含一个 "sub"（主题）声明，用作 mxid 的本地部分。

此外，如果存在，则验证过期时间（"exp"）、不早于时间（"nbf"）和签发时间（"iat"）声明。

请注意，这是一个非标准的登录类型，客户端支持预计不存在。

有关更多信息，请参见[此处](../../jwt.md)。

此设置的附加子选项包括：
* `enabled`：设置为 true 以启用使用 JSON Web Token 的授权。默认为 false。
* `secret`：这是用于解码 JSON Web Token 内容的私有共享密钥或公钥。如果 `enabled` 设置为 true，则必需。
* `algorithm`：用于签署（或 HMAC）JSON Web Token 的算法。支持的算法列在[此处（JWS 部分）](https://docs.authlib.org/en/latest/specs/rfc7518.html)。如果 `enabled` 设置为 true，则必需。
* `subject_claim`：包含用户唯一标识符的声明名称。可选，默认为 `sub`。
* `display_name_claim`：包含用户显示名称的声明名称。可选。如果提供，显示名称将在首次登录时设置为此声明的值。
* `issuer`：用于验证 "iss" 声明的发行者。可选。如果提供，则所有 JSON Web Token 都将要求并验证 "iss" 声明。
* `audiences`：用于验证 "aud" 声明的受众列表。可选。如果提供，则所有 JSON Web Token 都将要求并验证 "aud" 声明。
  请注意，如果 JSON Web Token 中包含 "aud" 声明，则在未配置受众的情况下，验证将失败。

示例配置：
```yaml
jwt_config:
    enabled: true
    secret: "provided-by-your-issuer"
    algorithm: "provided-by-your-issuer"
    subject_claim: "name_of_claim"
    display_name_claim: "name_of_claim"
    issuer: "provided-by-your-issuer"
    audiences:
        - "provided-by-your-issuer"
```

---  
### `password_config`  
使用此设置启用基于密码的登录。  
此设置具有以下子选项：  
* `enabled`：默认值为true。  
   设置为false以禁用密码认证。  
   设置为`only_for_reauth`时允许持有现有密码的用户用其重新认证（而不是登录），以防止新用户设置密码。  
* `localdb_enabled`：设置为false以禁用本地密码  
   数据库的身份验证。如果`enabled`为false，则忽略此项，且仅在拥有其他`password_providers`时有用。默认值为true。  
* `pepper`：在此处设置一个秘密随机字符串以提高安全性。  
   初次设置后请勿更改！  
* `policy`：定义并实施密码策略，如最小密码长度等。  
   每个参数都是可选的。这是MSC2000的实现。参数如下：  
   * `enabled`：默认值为false。设置为true以启用。  
   * `minimum_length`：密码接受的最小长度。默认值为0。  
   * `require_digit`：密码是否必须包含至少一个数字。  
      默认值为false。  
   * `require_symbol`：密码是否必须包含至少一个符号。  
      符号是非数字或字母的任何字符。默认值为false。  
   * `require_lowercase`：密码是否必须包含至少一个小写字母。  
      默认值为false。  
   * `require_uppercase`：密码是否必须包含至少一个大写字母。  
      默认值为false。  
配置示例：  
```yaml  
password_config:  
   enabled: false  
   localdb_enabled: false  
   pepper: "EVEN_MORE_SECRET"  
   policy:  
      enabled: true  
      minimum_length: 15  
      require_digit: true  
      require_symbol: true  
      require_lowercase: true  
      require_uppercase: true  
```  
---  
## 推送  
与推送通知相关的配置设置
---  
### `push`  
此设置定义了推送通知的选项。  
此选项具有多个子选项，具体如下：  
* `enabled`：启用或禁用推送通知计算。注意，禁用此功能还将  
   停止计算房间的未读计数。此操作模式适用于可能  
   仅连接有机器人或应用服务用户的家庭服务器，或其他不关注推送/未读计数的服务器。默认情况下启用。  
* `include_content`：请求推送通知的客户端可以在通知请求中  
   发送消息的正文以及其他细节（如发送者），或者只发送事件ID和房间ID（`event_id_only`）。  
   如果客户端选择发送正文，则此选项控制 
   通知请求是否包括事件的内容（仍然包括其他细节如发送者）。如果`event_id_only`启用，  
   则此项无效。  
   对于现代安卓设备，通知内容仍会出现，  
   因为它是通过应用加载的。然而iPhone，  
   只会发出通知说有一条消息到了，提示是谁发来的。  
   默认值为true。设置为false，只在推送通知中包含事件ID和房间ID。  
* `group_unread_count_by_room: false`：收到推送通知时，也会发送未读计数。  
   此数值可以计算为用户的未读消息数量，或者是*房间*的数量  
   用户在其中有未读消息。默认值为true，意味着推送客户端将在其中看到未读消息的房间数量。  
   设置为false则换为发送未读消息的数量。  
* `jitter_delay`：将推送通知延迟一段最长为给定时间的随机时长。  
  有助于减轻时间攻击。可选，默认不延迟。_在Synapse 1.84.0中添加。_  
配置示例：  
```yaml  
push:  
  enabled: true  
  include_content: false  
  group_unread_count_by_room: false  
  jitter_delay: "10s"  
```  
---  
## 房间  
与房间相关的配置选项。

---  
### `encryption_enabled_by_default_for_room_type`  
控制本地创建的房间是否默认启用端到端加密。  
可能的选项为"all"、"invite"和"off"。其定义为：  
* "all"：任何本地创建的房间  
* "invite"：任何使用`private_chat`或`trusted_private_chat`  
   房间创建预设创建的房间  
* "off"：此选项不生效  
默认值为"off"。  
请注意，此选项仅影响设置后创建的房间。  
此外，它不会影响其他服务器创建的房间。  
配置示例：  
```yaml  
encryption_enabled_by_default_for_room_type: invite  
```  
---  
### `user_directory`  
此设置定义了与用户目录相关的选项。  
此选项具有以下子选项：  
* `enabled`：定义用户是否可以搜索用户目录。如果为false则  
   所有查询都将返回空响应。默认值为true。  
* `search_all_users`：定义是否搜索在搜索执行时对你的家庭服务器可见的所有用户。  
   如果设置为true，将返回所有已知与搜索查询匹配的用户。  
   如果为false，搜索结果仅包含对请求者可见的公共房间或共享房间的用户。  
   默认值为false。  
    注意：如果你设置此项为true，而上次重建user_directory搜索  
    索引是在Synapse 1.44之前，你需要  
    通过API手动触发重建以搜索所有已知用户。  
    这些索引在Synapse第一次启动时创建；管理员可以  
    按照  
    [运行后台更新的说明](../administration/admin_api/background_updates.md#run)手动触发重建  
    设置为true以返回包括所有已知用户的搜索结果，即使该用户没有与请求者共享房间。  
* `prefer_local_users`：定义在搜索查询结果中是否更偏向本地用户。  
   如果设置为true，本地用户在搜索用户目录时更有可能出现在远程用户之前。默认值为false。  
* `show_locked_users`：定义是否在搜索查询结果中显示被锁定的用户。默认值为false。  
配置示例：  
```yaml  
user_directory:  
    enabled: false  
    search_all_users: true  
    prefer_local_users: true  
    show_locked_users: true  
```  
---  
### `user_consent`  
有关用户同意配置的详细说明，请参见[这里](../../consent_tracking.md)。  
如果在`listeners`下启用`consent`资源，则本节的部分内容是必需的，特别是`template_dir`和`version`。  
* `template_dir`：指定HTML表单的模板所在的位置。  
  此目录应包含一个语言子目录（如，`en`，`fr`），  
  每个语言目录应包含政策文件（命名为  
  `<version>.html`）和一个成功页面（success.html）。  
* `version`：指定政策文件的"当前"版本。定义  
   必要时由同意资源提供的版本。  
* `server_notice_content`，如果启用，将向用户发送一个"服务器通知"  
   请求他们同意隐私政策。[`server_notices`部分](#server_notices)  
   也必须配置。通知将*不*发给客人用户，除非`send_server_notice_to_guests`设置为true。

* 如果设置`block_events_error`，则会阻止任何发送事件的尝试，

   直到用户同意隐私政策。设置的值将作为错误的文本使用。

* `require_at_registration`，如果启用，将会在注册过程中增加一个步骤，

   类似于验证码工作方式。用户必须在账户创建前同意政策。

* `policy_name`是用户在注册账户时看到的政策显示名称。仅在启用`require_at_registration`时有效。

   默认值为"Privacy Policy"。

配置示例：

```yaml
user_consent:
  template_dir: res/templates/privacy
  version: 1.0
  server_notice_content:
    msgtype: m.text
    body: >-
      要继续使用此家庭服务器，您必须查看并同意
      在%(consent_uri)s的条款和条件
  send_server_notice_to_guests: true
  block_events_error: >-
    要继续使用此家庭服务器，您必须查看并同意
    在%(consent_uri)s的条款和条件
  require_at_registration: false
  policy_name: Privacy Policy
```

---  

### `stats`  
用于本地房间和用户统计信息收集的设置。请参见[这里](../../room_and_user_statistics.md)  
查看更多。

* `enabled`：设置为false以禁用房间和用户统计信息。注意，  
   这可能导致某些功能（如房间目录）无法正常工作。默认值为true。  
配置示例：  
```yaml  
stats:  
  enabled: false  
```  
---  
### `server_notices`  
使用此设置可以启用一个房间，以便从服务器向用户发送通知。  
这是一个用户无法离开的特殊房间；房间内的通知来自一个特殊的"notices"用户ID。  
如果你使用此设置，你*必须*定义`system_mxid_localpart`  
子设置，该设置定义用于发送通知的用户ID。  
此设置的子选项包括：  
* `system_mxid_display_name`：设置"notices"用户的显示名称  
* `system_mxid_avatar_url`：设置"notices"用户的头像  
* `room_name`：设置服务器通知房间的房间名称  
* `room_avatar_url`：可选字符串。服务器通知房间使用的房间头像。如果设置为空字符串`""`，则通知房间将不会有头像。默认值为空字符串。_在Synapse 1.99.0中添加。_  
* `room_topic`：可选字符串。服务器通知房间使用的主题。如果设置为空字符串`""`，则通知房间将不会有主题。默认值为空字符串。_在Synapse 1.99.0中添加。_  
* `auto_join`：布尔值。如果为true，用户将自动加入房间而不是被邀请。  
  默认值为false。_在Synapse 1.98.0中添加。_  
请注意，现有的服务器通知房间的名称、主题和头像将仅在发送新通知事件时更新。  
配置示例：  
```yaml  
server_notices:  
  system_mxid_localpart: notices  
  system_mxid_display_name: "Server Notices"  
  system_mxid_avatar_url: "mxc://example.com/oumMVlgDnLYFaPVkExemNVVZ"  
  room_name: "Server Notices"  
  room_avatar_url: "mxc://example.com/oumMVlgDnLYFaPVkExemNVVZ"  
  room_topic: "Room used by your server admin to notice you of important information"  
  auto_join: true  
```  
---  
### `enable_room_list_search`  
设置为false以禁用搜索公共房间列表。当禁用时，  
通过始终为所有查询返回空列表来禁止搜索本地和远程房间列表的本地和远程用户。默认值为true。  
配置示例：  
```yaml  
enable_room_list_search: false  
```  
---  
### `alias_creation_rules`  
`alias_creation_rules`选项允许服务器管理员防止不必要的  
在此服务器上创建别名。  
此设置是一个可选的0个或多个规则列表。默认情况下，没有提供列表，  
意味着允许所有别名创建。  
否则，创建别名的请求将按顺序匹配每个规则。  
第一个匹配的规则决定请求是否被允许或拒绝。如果没有  
规则匹配，请求被拒绝。特别注意的是，配置  
一个空规则列表将拒绝所有别名创建请求。 
每个规则是一个YAML对象，包含四个字段，每个字段都是可选的字符串：

* `user_id`：一个与别名创建者匹配的通配符模式。
* `alias`：一个与正在创建的别名匹配的通配符模式。
* `room_id`：一个与别名指向的房间ID匹配的通配符模式。
* `action`：`allow`或`deny`。如果规则匹配，如何处理请求。默认值为`allow`。

每个通配符模式是可选的，默认值为`*`（匹配任何东西）。

注意，模式是与完整合格ID匹配的，例如与
`@alice:example.com`、`#room:example.com` 和`!abcdefghijk:example.com`而不是`alice`、`room`和`abcedgghijk`。

配置示例：

```yaml
# 未指定规则列表。所有别名创建均被允许。

# 这是默认行为。

alias_creation_rules:
```

```yaml
# 允许所有内容的单一规则列表。

# 与前一个示例具有相同效果。

alias_creation_rules:
  - "action": "allow"

```

```yaml
# 空规则列表。所有别名创建均被拒绝。

alias_creation_rules: []
```

```yaml
# 规则列表中一个部分拒绝所有内容。

# 与前一个示例具有相同效果。

alias_creation_rules:
  - "action": "deny"

```

```yaml
# 防止一个特定用户创建别名。

# 允许其他用户创建任何别名
alias_creation_rules:
  - user_id: "@bad_user:example.com"

    action: deny
  - action: allow
```

```yaml
# 阻止指向特定房间的别名。

alias_creation_rules:
  - room_id: "!forbiddenRoom:example.com"

    action: deny
  - action: allow
```
---  
### `room_list_publication_rules`  
`room_list_publication_rules`选项允许服务器管理员防止  
不需要的条目被发布到公共房间列表中。  
该选项的格式与  
[`alias_creation_rules`](#alias_creation_rules)相同：一个可选的0个或多个  
规则列表。默认情况下，没有提供列表，意味着所有房间  
都可以发布到房间列表中。  
否则，发布房间的请求将按顺序匹配每个规则。  
第一个匹配的规则决定请求是否被允许或拒绝。如果没有  
规则匹配，请求被拒绝。特别注意的是，配置  
一个空规则列表将拒绝所有别名创建请求。  
请求创建一个违反  
配置规则的公开（即发布到房间目录）的房间将导致  
房间被创建但不会发布到房间目录。  
每个规则是一个YAML对象，包含四个字段，每个字段都是可选的字符串：

* `user_id`：一个与发布房间的用户匹配的通配符模式。
* `alias`：一个与发布房间的别名之一匹配的通配符模式。

  - 如果房间没有别名，除非未指定或为`*`，否则别名匹配失败。

  - 如果房间仅有一个别名，别名匹配，如果`alias`模式匹配，则成功。

  - 如果房间有两个或多个别名，别名匹配，如果模式匹配多个别名中的至少一个，则成功。

* `room_id`：一个与被发布房间的房间ID匹配的通配符模式。
* `action`：`allow`或`deny`。如果规则匹配，如何处理请求。默认值为`allow`。

每个通配符模式是可选的，默认值为`*`（匹配任何东西）。

注意，模式是与完整合格ID匹配的，例如与
`@alice:example.com`、`#room:example.com` 和`!abcdefghijk:example.com`而不是`alice`、`room`和`abcedgghijk`。

示例配置：

```yaml
# 未指定规则列表。任何人都可以将任何房间发布到公共列表。

# 这是默认行为。

room_list_publication_rules:
```

```yaml
# 允许所有内容的单一规则列表。

# 与前一个示例具有相同效果。

room_list_publication_rules:
  - "action": "allow"

```

```yaml
# 空规则列表。无人可发布到房间列表。

room_list_publication_rules: []
```

```yaml
# 规则列表中一个部分拒绝所有内容。

# 与前一个示例具有相同效果。

room_list_publication_rules:
  - "action": "deny"

```

```yaml
# 阻止一个特定用户发布房间。

# 允许其他用户发布任何内容。

room_list_publication_rules:
  - user_id: "@bad_user:example.com"

    action: deny
  - action: allow
```

```yaml
# 防止发布特定房间。

room_list_publication_rules:
  - room_id: "!forbiddenRoom:example.com"

    action: deny
  - action: allow
```

```yaml
# 防止包含"potato"字样的别名之一的房间发布。

room_list_publication_rules:
  - alias: "#*potato*:example.com"

    action: deny
  - action: allow
```
---  
### `default_power_level_content_override`  
`default_power_level_content_override`选项控制房间的默认权限等级。  
如果您知道您的用户在他们创建的房间内需要特殊权限（例如，发送特定类型的状态事件而无需提升权限等级），则非常有用。此选项与/createRoom API中的`power_level_content_override`参数使用相同的结构，但在该参数之前应用。

请注意，在预设中每个提供的键（例如，下面示例中的`events`）将覆盖该键中的所有现有默认值。因此在下面的示例中，新创建的private_chat房间将不会有除`com.example.foo`外其他事件类型的规则。  
示例配置：  
```yaml  
default_power_level_content_override:  
   private_chat: { "events": { "com.example.foo" : 0 } }  
   trusted_private_chat: null  
   public_chat: null  
```  
每个预设的默认权限等级为：  
```yaml  
"m.room.name": 50  
"m.room.power_levels": 100  
"m.room.history_visibility": 100  
"m.room.canonical_alias": 50  
"m.room.avatar": 50  
"m.room.tombstone": 100  
"m.room.server_acl": 100  
"m.room.encryption": 100  
```  
因此一个保持每个预设的默认权限等级但为新键设置权限等级的完整示例为：  
```yaml  
default_power_level_content_override:
   private_chat:
    events:
      "com.example.foo": 0
      "m.room.name": 50
      "m.room.power_levels": 100
      "m.room.history_visibility": 100
      "m.room.canonical_alias": 50
      "m.room.avatar": 50
      "m.room.tombstone": 100
      "m.room.server_acl": 100
      "m.room.encryption": 100
   trusted_private_chat: null
   public_chat: null
```

---

### `forget_rooms_on_leave`
设置为 true 时，当用户离开房间时，无论是正常方式还是通过踢出或禁止，都会自动忘记该房间。默认为 false。

示例配置：

```yaml
forget_rooms_on_leave: false
```
---
### `exclude_rooms_from_sync`
一个房间列表，从同步响应中排除。这对于希望将用户分组到一个房间的服务器管理员很有用，而这些用户无法从他们的客户端看到该房间。

默认情况下，没有房间被排除。

示例配置：

```yaml
exclude_rooms_from_sync:
    - "!foo:example.com"

```
---
## Opentracing
与 Opentracing 支持相关的配置选项。

---
### `opentracing`
这些设置启用和配置 opentracing，它实现了分布式跟踪。这使您能够观察横跨服务器的事件因果链，包括请求、键查找等，跨所有运行 synapse 或其他支持 opentracing 的服务（特别是那些使用 Jaeger 实现的服务）。

子选项包括：

* `enabled`：是否启用跟踪。设置为 true 以启用。默认禁用。
* `homeserver_whitelist`：我们希望发送和接收跨度上下文和跨度凭据的 homeservers 列表。

   请参阅 [这里](../../opentracing.md) 获取更多信息。

   这是一个正则表达式列表，将匹配 homeserver 的 `server_name`。

   默认情况下，它是空的，因此没有匹配到的服务器。

* `force_tracing_for_users`：# 一个 matrix 用户 ID 列表，这些用户的请求将始终被跟踪，

   即使跟踪系统因概率采样而可能丢弃该跟踪。

   默认情况下，该列表为空。

* `jaeger_config`：Jaeger 可配置以不同的速率采样跟踪。

   提供的所有 Jaeger 配置选项均可在此处设置。Jaeger 的配置主要与跟踪采样相关，可在 [此处](https://www.jaegertracing.io/docs/latest/sampling/) 查阅文档。

示例配置：

```yaml
opentracing:
    enabled: true
    homeserver_whitelist:
      - ".*"
    force_tracing_for_users:
      - "@user1:server_name"
      - "@user2:server_name"

    jaeger_config:
      sampler:
        type: const
        param: 1
      logging:
        false
```
---
## 协调工作进程
与主配置文件中的工作进程相关的配置选项（通常称为 `homeserver.yaml`）。

可以通过运行多个称为 _workers_ 的 Synapse 进程水平扩展 Synapse 部署。

传入的请求在 workers 之间分配以处理较高负载。一些 workers 有特权，可以接受来自其他 workers 的请求。

因此，worker 配置分为两部分。

1. 第一部分（在本手册的这一节中）定义了可分担的任务委托给特权工作进程。这允许无特权工作进程代表其请求特权工作进程执行操作。

1. [第二部分](#individual-worker-configuration)
   控制个别工作进程的独立行为。

有关设置 workers 的指导，请参阅 [worker 文档](../../workers.md)。

---
### `worker_replication_secret`
用于通过主进程的复制 APIs 认证来自 work
ers 的 HTTP 请求的共享秘密。

默认情况下，此值被省略（相当于 `null`），这意味着 workers 和主进程之间的流量未经过认证。

示例配置：

```yaml
worker_replication_secret: "secret_secret"

```
---
### `start_pushers`
如果使用 [`pusher_instances`](#pusher_instances) 并配合 [`generic_workers`](../../workers.md#synapseappgeneric_worker)，则无需设置。

控制主进程上推送通知的发送。如果使用 [pusher worker](../../workers.md#synapseapppusher)，则设置为 `false`。默认为 `true`。

示例配置：

```yaml
start_pushers: false
```
---
### `pusher_instances`
可以通过运行 [`generic_worker`](../../workers.md#synapseappgeneric_worker) 并将其 [`worker_name`](#worker_name) 添加到 `pusher_instances` 映射中来缩放处理向 [sygnal](https://github.com/matrix-org/sygnal) 发送推送通知和电子邮件的进程。这样做会将此功能的处理从主进程中移除。可以将多个工作进程添加到此映射中，在这种情况下，工作会在它们之间平衡。更改此选项后，请确保主进程和所有推送工作进程重新启动。

单个工作进程的示例配置：

```yaml
pusher_instances:
  - pusher_worker1
```
多个工作进程的示例配置：

```yaml
pusher_instances:
  - pusher_worker1
  - pusher_worker2
```
---
### `send_federation`
如果使用 [`federation_sender_instances`](#federation_sender_instances) 配合 [`generic_workers`](../../workers.md#synapseappgeneric_worker)，则无需设置。

控制主进程上出站联合事务的发送。

如果使用 [联合发送者工作进程](../../workers.md#synapseappfederation_sender)，则设置为 `false`。

默认为 `true`。

示例配置：

```yaml
send_federation: false
```
---
### `federation_sender_instances`
通过运行 [`generic_worker`](../../workers.md#synapseappgeneric_worker) 并将其 [`worker_name`](#worker_name) 添加到 `federation_sender_instances` 映射中，可以缩放处理发送出站联合请求的进程。这样做将从主进程中移除此功能的处理。可以将多个工作进程添加到此映射中，在这种情况下，工作会在它们之间平衡。

负载均衡的工作原理是任何出站联合请求将根据目标服务器名称的哈希分配给联合发送者工作进程。这意味着所有发送到相同目的地的请求将由同一工作进程实例处理。多个 `federation_sender_instances` 有助于在多个 服务器之间进行联合。

此配置设置必须在处理联合发送的所有工作进程之间共享，如果更改，所有联合发送者工作进程必须同时停止然后启动，以确保所有实例运行相同的配置（否则事件可能会丢失）。

单个工作进程的示例配置：

```yaml
federation_sender_instances:
  - federation_sender1
```
多个工作进程的示例配置：

```yaml
federation_sender_instances:
  - federation_sender1
  - federation_sender2
```
---
### `instance_map`
使用 workers 时，这应为从 [`worker_name`](#worker_name) 到工作进程的 HTTP 复制监听器（如果已配置）以及主进程的映射。在 [`stream_writers`](../../workers.md#stream-writers) 和 [`outbound_federation_restricted_to`](#outbound_federation_restricted_to) 下声明的每个工作进程都需要一个 HTTP 复制监听器，并且该监听器应该包含在 `instance_map` 中。主进程也需要在 `instance_map` 上有一个条目，如果即使只有一个其他工作进程存在，也应列在 `main` 下。确保端口与为 `replication` 监听器声明的 `listener` 块内部的配置相匹配。

示例配置：

```yaml
instance_map:
  main:
    host: localhost
    port: 8030
  worker1:
    host: localhost
    port: 8034
```
使用 UNIX 套接字的示例配置(#2)：

```yaml
instance_map:
  main:
    path: /run/synapse/main_replication.sock
  worker1:
    path: /run/synapse/worker1_replication.sock
```
---
### `stream_writers`
实验性功能: 使用 workers 时，可以定义哪个 workers 应该处理写入数据流，例如事件持久性和打字通知。此处指定的任何 worker 必须也在 [`instance_map`](#instance_map) 中。

可用数据流的列表请参阅
[worker 文档](../../workers.md#stream-writers)。

示例配置：

```yaml
stream_writers:
  events: worker1
  typing: worker1
```
---
### `outbound_federation_restricted_to`
使用 workers 时，可以限制出站联合流量只能通过特定的一组 workers。此处指定的任何 worker 必须也在 [`instance_map`](#instance_map) 中。

必须也配置 [`worker_replication_secret`](#worker_replication_secret) 以授权工人间的通讯。

```yaml
outbound_federation_restricted_to:
  - federation_sender1
  - federation_sender2
```
更多信息请参阅 [worker 文档](../../workers.md#restrict-outbound-federation-traffic-to-a-specific-set-of-workers)。

_在 Synapse 1.89.0 中新增。_

---
### `run_background_tasks_on`
用于运行后台任务（例如清理过期数据）的 [worker](../../workers.md#background-tasks)。如果未提供，则默认为主进程。

示例配置：

```yaml
run_background_tasks_on: worker1
```
---
### `update_user_directory_from_worker`
用于更新用户目录的 [worker](../../workers.md#updating-the-user-directory)。如果未提供，则默认为主进程。

示例配置：

```yaml
update_user_directory_from_worker: worker1
```
_在 Synapse 1.59.0 中新增。_

---
### `notify_appservices_from_worker`
用于向应用服务发送输出流量的 [worker](../../workers.md#notifying-application-services)。如果未提供，则默认为主进程。

示例配置：

```yaml
notify_appservices_from_worker: worker1
```
_在 Synapse 1.59.0 中新增。_

---
### `media_instance_running_background_jobs`
用于为媒体存储库运行后台任务的 [worker](../../workers.md#synapseappmedia_repository)。如果运行多个媒体存储库，则必须配置一个实例来运行后台任务。如果未提供，则默认为主进程或单独的 `media_repository` 工作进程。

示例配置：

```yaml
media_instance_running_background_jobs: worker1
```
_在 Synapse 1.16.0 中新增。_

---
### `redis`
使用 workers 时的 Redis 配置。使用 workers 时 *必须* 启用此设置。

此设置具有以下子选项：

* `enabled`：是否使用 Redis 支持。默认不启用。
* `host` 和 `port`：可选的主机和端口用于连接 redis。默认为 localhost 和 6379
* `path`：本地 Unix 套接字文件的完整路径。**如果使用此选项，`host` 和 `port` 将被忽略。** 默认为 `/tmp/redis.sock'
* `password`：可选的密码，如果在 Redis 实例上配置。
* `password_path`：`password` 的替代选项，从外部文件读取密码。文件应为纯文本文件，仅包含密码。Synapse 会在启动时从给定文件读入密码一次。
* `dbid`：可选的 redis dbid，如果需要连接到特定的 redis 逻辑 db。
* `use_tls`：是否使用 tls 连接。默认不启用。
* `certificate_file`：可选的证书文件路径
* `private_key_file`：可选的私钥文件路径
* `ca_file`：可选的 CA 证书文件路径。使用此选项或：
* `ca_path`：包含 CA 证书文件的文件夹路径
  _在 Synapse 1.78.0 中增加。_
  _在 Synapse 1.84.0 中更改：增加 use_tls, certificate_file, private_key_file, ca_file 和 ca_path 属性_
  _在 Synapse 1.85.0 中更改：增加 path 选项以使用本地 Unix 套接字_
  _在 Synapse 1.116.0 中更改：增加 password_path_
示例配置：

```yaml
redis:
  enabled: true
  host: localhost
  port: 6379
  password_path: <path_to_the_password_file>
  # OR password: <secret_password>
  dbid: <dbid>
  #use_tls: True
  #certificate_file: <path_to_the_certificate_file>
  #private_key_file: <path_to_the_private_key_file>
  #ca_file: <path_to_the_ca_certificate_file>
```
---
## 个别工作进程配置
这些选项在其工作进程配置文件中配置个别工作进程。

配置主进程时不应提供它们。

还请注意上面关于 [协调 workers 集群](#coordinating-workers) 的配置。

有关设置 work
ers 的指导，请参阅 [worker 文档](../../workers.md)。

---
### `worker_app`
工作进程的类型。目前可用的工作进程应用程序在 [worker 文档](../../workers.md#available-worker-applications) 中列出。

最常见的工作进程是
[`synapse.app.generic_worker`](../../workers.md#synapseappgeneric_worker)。

示例配置：

```yaml
worker_app: synapse.app.generic_worker
```
---
### `worker_name`
worker 的唯一名称。worker 需要一个名称，以便在进一步的参数和日志文件中识别。我们强烈建议给每个 worker 一个唯一的 `worker_name`。

示例配置：

```yaml
worker_name: generic_worker1
```
---
### `worker_listeners`
worker 可以处理 HTTP 请求。为此，必须声明一个 `worker_listeners` 选项，与共享配置中的 [`listeners` 选项](#listeners) 相同。

在 [`stream_writers`](#stream_writers) 和 [`instance_map`](#instance_map) 中声明的 workers 需要在此处包含一个 `replication` 监听器，以便接受来自其他 workers 的内部 HTTP 请求。

示例配置：

```yaml
worker_listeners:
  - type: http
    port: 8083
    resources:
      - names: [client, federation]
```
使用 UNIX 套接字和 `replication` 监听器的示例配置(#2)：

```yaml
worker_listeners:
  - type: http
    path: /run/synapse/worker_replication.sock
    resources:
      - names: [replication]
  - type: http
    path: /run/synapse/worker_public.sock
    resources:
      - names: [client, federation]
```
---
### `worker_manhole`
worker 可能有一个用于 [`manhole`](../../manhole.md) 的监听器。

这允许服务器管理员访问 worker 上的 Python shell。

示例配置：

```yaml
worker_manhole: 9000
```
这是一个简短形式：

```yaml
worker_listeners:
  - port: 9000
    bind_addresses: ['127.0.0.1']
    type: manhole
```
它还需要额外的 [`manhole_settings`](#manhole_settings) 配置。

---
### `worker_daemonize`
指定是否将 worker 作为守护进程启动。

如果 Synapse 由 [systemd](../../systemd-with-workers/) 管理，则必须省略此选项或将其设置为 `false`。

默认值为 `false`。

示例配置：

```yaml
worker_daemonize: true
```
---
### `worker_pid_file`
以守护进程运行 worker 时，我们需要一个地方存储 worker 的 [PID](https://en.wikipedia.org/wiki/Process_identifier)。

此选项定义了那个 "pid 文件" 的位置。

如果 `worker_daemonize` 为 `true`，则此选项为必需，否则忽略。没有预设值。

另请参阅主 Synapse 进程的 [`pid_file` 选项](#pid_file)。

示例配置：

```yaml
worker_pid_file: DATADIR/generic_worker1.pid
```
---
### `worker_log_config`
此选项指定了一个 yaml python 日志配置文件，如 [here](https://docs.python.org/3/library/logging.config.html#configuration-dictionary-schema) 中描述的。

另请参阅主 Synapse 进程的 [`log_config` 选项](#log_config)。

示例配置：

```yaml
worker_log_config: /etc/matrix-synapse/generic-worker-log.yaml
```
---
## 后台更新
与后台更新相关的配置设置。

---
### `background_updates`
后台更新是在后台批量运行的数据库更新。

可以配置运行更新的持续时间、最小批量大小、默认批量大小、是否在批次之间停顿以及如果停顿，停多长时间。这有助于加速或减慢更新。

此设置具有以下子选项：

* `background_update_duration_ms`：运行后台更新一批所需的毫秒数。默认为 100。

   设置不同的时间以更改默认值。

* `sleep_enabled`：是否在更新之间停顿。默认为 true。设置为 false 以更改默认值。
* `sleep_duration_ms`：如果在更新之间停顿，停顿多长时间（毫秒）。默认为 1000。

   设置持续时间以更改默认值。

* `min_batch_size`：后台更新批次的最小大小。必须大于 0。默认为 1。

   设置大小以更改默认值。

* `default_batch_size`：新后台更新首次迭代使用的批量大小。默认值为 100。

   设置大小以更改默认值。

示例配置：

```yaml
background_updates:
    background_update_duration_ms: 500
    sleep_enabled: false
    sleep_duration_ms: 300
    min_batch_size: 10
    default_batch_size: 50
```
---
## 自动接受邀请
与自动接受邀请相关的配置设置。

---
### `auto_accept_invites`
自动接受邀请控制用户是否会收到邀请请求，或在收到邀请时是否自动加入房间。将 `enabled` 子选项设为 true 以启用自动接受邀请。默认为 false。

此设置具有以下子选项：

* `enabled`：是否运行自动接受邀请逻辑。默认为 false。
* `only_for_direct_messages`：是否应为所有房间类型自动接受邀请，还是仅限于直接消息。默认为 false。
* `only_from_local_users`：是否仅自动接受来自本地 homeserver 的用户邀请。默认为 false。
* `worker_to_run_on`：运行此模块的工作进程。必须匹配 "worker_name"。如果未设置或为 `null`，

则在主进程上接受邀请。

注意：不要在启用并安装 `synapse_auto_accept_invite` 模块时启用此设置，以避免竞争执行相同任务，并可能导致不良行为。例如，可能从单个邀请生成多个加入事件。

示例配置：

```yaml
auto_accept_invites:
    enabled: true
    only_for_direct_messages: true
    only_from_local_users: true
    worker_to_run_on: "worker_1"

```