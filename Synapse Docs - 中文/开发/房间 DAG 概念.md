### 房间 DAG 概念

#### 边

“边”一词来自图论术语。边只是两个事件之间的连接。在Synapse中，我们通过指定它们的`prev_events`来连接事件。后续事件指向前一个事件。

```
A (最旧) <---- B <---- C (最新)
```

#### 深度和流序

事件通常按`(topological_ordering, stream_ordering)`排序，其中`topological_ordering`只是`depth`。换句话说，我们首先按`depth`排序，然后根据`stream_ordering`进行平局决胜。随着新消息被添加到DAG中，`depth`会递增。通常，`stream_ordering`是一个自动递增的整数，但回填事件以`stream_ordering=-1`开始并递减。

---

 - 增量`/sync?since=xxx`按事件到达服务器的顺序返回内容（`stream_ordering`）。
 - 初始`/sync`、`/messages`（以及联邦API中的`/backfill`）按事件图确定的顺序返回内容`(topological_ordering, stream_ordering)`。

一般的想法是，如果您实时跟踪一个房间（即`/sync`），您可能希望看到消息在到达服务器时的样子，而不是跳过任何迟到的消息；而如果您查看时间线的历史部分（即`/messages`），您希望看到房间状态的最佳表示，就像其他人在当时看到的一样。

#### Outliers

当我们尚未确定DAG中某点的房间状态时，我们将事件标记为`outlier`。它们是我们尚未关联到DAG的“浮动”事件。

当我们获取给定事件的认证链或状态时，通常会出现异常。当这种情况发生时，我们只是获取状态/认证链中的事件，而不计算这些事件的状态，或回填它们的`prev_events`。由于我们没有以这种方式获取的任何事件的状态，我们将它们标记为异常。

因此，通常我们不会在数据库中拥有异常的`prev_events`，（尽管完全有可能由于其他原因我们*可能*拥有它们）。其他使异常与常规事件不同的事情：

 * 我们没有它们的状态，因此在`event_to_state_groups`中不应有异常的条目。（实际上情况并非总是如此，尽管我不确定原因：参见https://github.com/matrix-org/synapse/issues/12201）。

 * 我们不为它们在`event_edges`、`event_forward_extremeties`或`event_backward_extremeties`表中记录条目。

由于异常未与DAG绑定，它们通常不会成为通过`/sync`或`/messages`发送给客户端的时间线的一部分；但有一个例外：

##### Out-of-band 成员事件

异常事件的一个特殊情况是我们不是完全成员的联邦房间的一些成员事件。例如：

 * 在我们加入房间之前通过联邦接收到的邀请
 * 对上述邀请的*拒绝*
 * 我们想加入但尚未加入的房间的敲门事件。

在上述所有情况下，我们没有房间的状态，这就是为什么它们被视为异常。它们有点特别，因为它们通过`/sync`主动发送给客户端。

#### Forward extremity

DAG中时间上最近的事件尚未被任何其他事件的`prev_events`引用。（在此定义中，异常、被拒绝的事件和软失败的事件不算在内。）

房间的前向极限（或至少其中的一个子集，如果超过十个）用作下一个事件发送时的`prev_events`。

房间的“当前状态”（即：如果我们生成一个新事件将使用的状态）因此是每个前向极限的房间状态的分辨率。

#### Backward extremity

我们已经回填到的当前标记，通常是我们在DAG中拥有的时间上最旧的事件的`prev_events`。这为回填历史提供了起点。

请注意，与前向极限不同，我们通常不会在数据库中拥有任何后向极限事件——或者，如果我们有，它们将是“异常”（见上文）。无论哪种方式，我们都不期望在后向极限处拥有房间状态。

当我们持久化一个非异常事件时，如果它以前是一个后向极限，我们将其清除为后向极限，并将其所有`prev_events`设置为新的后向极限，如果它们尚未作为非异常持久化。这因此保持了后向极限的最新状态。

#### 状态组

对于每个非异常事件，我们需要知道该事件的状态。我们没有在数据库中为每个事件存储完整状态（即`event_id -> state`映射），因为当状态没有改变时，这种方式非常不节省空间，我们改为为每个不同的状态集分配一个“状态组”，然后有`event_id -> state_group`和`state_group -> state`的映射。

##### Stage group edges

TODO: `state_group_edges`是进一步的优化...
      来自@Azrenbeth的笔记，https://pastebin.com/seUGVGeT