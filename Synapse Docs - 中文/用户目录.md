### 用户目录 API 实现

用户目录是基于对 homeserver '可见' 的用户来维护的 - 即服务器本地用户以及与任何本地用户共享房间的用户。

目录信息存储在多个表中，这些表有时可能会不同步（尽管这被认为是一个错误）。如果发生这种情况，目前的解决方案是使用管理 API 并执行作业 `regenerate_directory` 。这将启动一个后台任务来清空当前表并重新生成目录。根据您的家庭服务器的大小（用户和房间的数量），这可能需要一些时间。

#### 数据模型

有五个相关的表共同构成了“用户目录”。其中三个表跟踪所有已知用户的列表。最后两个（统称为“搜索表”）跟踪哪些用户彼此可见。

从所有这些表中我们排除了三种类型的本地用户：

*   支持用户
*   应用服务用户
*   已停用用户

以下是每个表的描述：

*   `user_directory` . 这包含每个用户的用户 ID、显示名称和头像。
*   由于每个用户只有一个目录条目，因此它只能包含公开可见的信息。否则，这将泄露在私人房间中使用的昵称或头像。
*   按房间索引。按用户索引。
*   `user_directory_search` . 将加入到 `user_directory` . 它包含一个额外的列，基于用户 ID 和显示名称启用全文搜索。SQLite 和 Postgres 使用不同的模式。
*   在全文搜索数据上建立索引。在用户上建立索引。
*   `user_directory_stream_pos` . 当初始后台更新以填充目录完成时，我们在这里记录一个流位置。这表明 synapse 现在应该监听房间变化，并在必要时增量更新目录。（参见流位置。）
*   `users_in_public_rooms` . 包含用户与他们所在的公共房间之间的关联。用于确定哪些用户在公共房间中，并且应该在目录中公开可见。跟踪本地和远程用户。
*   `users_who_share_private_rooms` . 行是三元组 `(L, M, room id)` ，其中 `L` 是本地用户， `M` 是本地或远程用户。 `L` 和 `M` 应该不同，但这不是由约束强制执行的。

注意，如果两个本地用户共享一个房间，那么将会有两个条目： `(user1, user2, !room_id)` 和 `(user2, user1, !room_id)` 。

#### 配置选项

用户搜索的工作方式可以通过一些服务器级别的配置选项进行调整。

此处不重复信息，但下文提到了选项。

#### 搜索算法

如果 `search_all_users` 是 `false` ，那么结果将限于以下用户：

1. 在 `users_in_public_rooms` 表中找到，或
2. 可以在 `users_who_share_private_rooms` 中找到，其中 `L` 是请求用户， `M` 是搜索结果。

否则，如果 `search_all_users` 是 `true` ，则不会设置此类限制，将返回服务器已知的所有用户（匹配搜索查询）。

默认情况下，不返回被锁定的用户。如果 `show_locked_users` 是 `true` ，则不会对用户的锁定状态进行过滤。

用户提供的搜索词被转换为小写并使用 NFKC 进行标准化，这使得字符串不区分大小写，规范化了同一文本的不同形式，并将一些“基本等同”的字符映射在一起。

搜索词将被拆分为单词：

*   如果 ICU 可用，则系统的默认区域设置将用于将搜索词拆分为单词。 （请参阅安装说明以了解如何安装 ICU。）
*   如果不可用，则将 ASCII 字符、数字、下划线和连字符的连续序列视为单词。

PostgreSQL 和 SQLite 的查询详细列出如下，但它们的总体目标是查找匹配的用户，优先选择“真实”的用户（例如，不是机器人，不是已停用的）。假设真实用户会设置显示名称和头像。

##### PostgreSQL

然后上述词语被转换成两个查询：

1. “exact” 精确匹配解析的单词（使用 `to_tsquery` ）；
2. “prefix” 作为前缀匹配解析的单词（使用 `to_tsquery` ）。

结果由 `user_directory_search` 表中所有信息匹配其中一个（或两个）查询的行组成。结果通过为每个结果计算一个加权分数来排序，分数高的优先返回：

*   如果用户 ID 存在，则 4 倍。
*   如果用户设置了显示名称，则 1.2 倍。
*   如果用户设置了头像，则 1.2 倍。
*   通过使用 `ts_rank_cd` 函数对“exact”搜索查询的全文搜索结果，0x-3x；这有四个变量，其权重如下：
*   `D` : 0.1 用于用户 ID 的域名
*   `C` : 0.1 用于未使用
*   `B` : 0.9 用于用户的显示名称（如果未设置则为空字符串）
*   `A` : 0.1 用于用户 ID 的本地部分
*   0x-1x 通过使用 `ts_rank_cd` 函数对“前缀”搜索查询的全文搜索结果。（使用与上述相同的权重。）
*   如果 `prefer_local_users` 是 `true` ，则如果用户在主服务器本地，则为 2x。

注意 `ts_rank_cd` 返回的权重在 0 和 1 之间。所有结果的初始权重为 1。

##### SQLite

结果由 `user_directory_search` 中所有与查询匹配的信息行组成。结果按以下信息排序，每个后续列用作每个结果的决胜局：

1. 通过使用 `matchinfo` 函数对全文搜索结果的 `rank` 进行排序。优先返回较高排名。
2. 如果 `prefer_local_users` 是 `true` ，则首先返回本地用户。
3. 首先返回已设置显示名的用户。
4. 首先返回已设置头像的用户。